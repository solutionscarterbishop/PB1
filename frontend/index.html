<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PB1 Executive Dashboard</title>
  <style>
    :root{
      --bg:#110b0b;
      --card:#1a1212;
      --card2:#130d0d;
      --text:#f7f2f2;
      --text-strong:#fff7f7;
      --muted:#b7a9a9;
      --border:rgba(255,255,255,.08);
      --shadow: 0 12px 32px rgba(0,0,0,.45);
      --radius:16px;
      --radius2:14px;
      --glow: 0 0 0 1px rgba(255,255,255,.06), 0 12px 40px rgba(0,0,0,.55);
      --accent:#7a1f1f;
      --accent-strong:#9b1c1c;
      --good: rgba(110,210,160,.18);
      --warn: rgba(230,190,100,.16);
      --bad:  rgba(230,120,120,.14);
    }
    body[data-theme="light"]{
      --bg:#f7f2ee;
      --card:#fffaf6;
      --card2:#f3ebe5;
      --text:#2b1a1a;
      --text-strong:#1f1212;
      --muted:#5f4d4d;
      --border:rgba(60,30,30,.18);
      --shadow: 0 10px 22px rgba(40,10,10,.16);
      --glow: 0 0 0 1px rgba(60,30,30,.12), 0 10px 26px rgba(40,10,10,.10);
      --accent:#7a1f1f;
      --accent-strong:#8e1f1f;
      --good: rgba(50,150,100,.22);
      --warn: rgba(210,160,80,.22);
      --bad:  rgba(200,80,80,.18);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:24px;
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(255,255,255,.05), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(255,255,255,.04), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    .wrap{ max-width: 1240px; margin: 0 auto; }

    h1{ margin:0 0 6px 0; font-size:42px; letter-spacing:-0.5px; color:var(--text-strong); }
    .live-row{ display:flex; gap:10px; align-items:center; margin:4px 0 10px; flex-wrap:wrap; }
    .live-badge{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(90,200,130,.35);
      background: rgba(90,200,130,.12);
      font-size:12px;
      color: var(--text-strong);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .live-badge::before{
      content:"";
      width:7px;
      height:7px;
      border-radius:50%;
      background:#4fd087;
      box-shadow:0 0 8px rgba(79,208,135,.7);
      display:inline-block;
    }
    .subline{ color:var(--muted); font-size:13px; margin-bottom:18px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:rgba(255,255,255,.03); }
    body[data-theme="light"] .pill,
    body[data-theme="light"] .badge,
    body[data-theme="light"] .chip,
    body[data-theme="light"] .tag{
      background: rgba(0,0,0,.03);
      border-color: var(--border);
    }

    .error-banner{
      display:none;
      padding:12px 14px;
      border:1px solid rgba(255,120,120,.35);
      border-radius: 12px;
      background: rgba(255,80,80,.08);
      color:#ffd7d7;
      margin: 12px 0 0;
      font-size:13px;
    }
    .error-banner.warn{
      border-color: rgba(230,190,100,.45);
      background: rgba(230,190,100,.12);
      color:#ffe9b8;
    }

    .toolbar{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
      margin:14px 0 16px;
      padding: 14px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.02);
      box-shadow: var(--glow);
    }
    select, input{
      height:40px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card2);
      color:var(--text);
      padding:0 12px;
      outline:none;
      box-shadow:none;
    }
    button{
      height:40px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:0 12px;
      outline:none;
      box-shadow:none;
    }
    input{ width: 220px; }
    button{ cursor:pointer; }
    button:hover{ background:rgba(255,255,255,.06); }
    .btn-ghost{ background:rgba(255,255,255,.02); }
    .btn-ghost:hover{ background:rgba(255,255,255,.05); }
    .btn-primary{ border-color: rgba(255,255,255,.18); background:var(--accent); color:#fff; }
    .btn-primary:hover{ background:var(--accent-strong); }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(180px, 1fr));
      gap:14px;
      margin-bottom:16px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
      min-height:92px;
    }
    .kpi-label{ font-size:12px; color:var(--muted); margin-bottom:8px; }
    .kpi-value{ font-size:30px; font-weight:700; letter-spacing:-0.4px; }
    .kpi-sub{ font-size:12px; color: var(--muted); margin-top: 6px; }

    .section-title{
      margin:18px 0 10px;
      font-size:16px;
      color:var(--text-strong);
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .hint{ font-size:12px; color:var(--muted); font-weight:500; }

    .table-wrap{
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    thead th{
      text-align:left;
      padding:12px 12px;
      font-size:12px;
      color:var(--muted);
      background: rgba(255,255,255,.03);
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:1;
      white-space: nowrap;
      user-select:none;
    }
    thead th.sortable{ cursor:pointer; }
    thead th.sortable:hover{ background: rgba(255,255,255,.045); }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      vertical-align: top;
    }
    tbody tr{ cursor:pointer; }
    tbody tr:hover{ background: rgba(255,255,255,.04); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .right{ text-align:right; }

    /* Executive summary */
    .exec-grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
      margin-bottom:16px;
    }
    .exec-card{
      background: linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.015));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .exec-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .exec-title h2{
      margin:0;
      font-size:16px;
      letter-spacing:-0.2px;
    }
    .summary{
      color: var(--text);
      font-size:13px;
      line-height:1.45;
      white-space:pre-wrap;
    }
    .badge-row{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      font-size:12px;
      color: var(--text);
    }
    .barWrap{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .barRow{ display:flex; align-items:center; gap:10px; }
    .barLbl{ width:82px; font-size:12px; color: var(--muted); }
    .bar{
      flex:1;
      height:10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.25);
      overflow:hidden;
    }
    .bar > span{
      display:block;
      height:100%;
      width:0%;
      background: rgba(255,255,255,.85);
    }
    .barVal{ width:56px; text-align:right; font-size:12px; color: var(--muted); }

    /* Priority panel */
    .prioGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .prioTile{
      border:1px solid var(--border);
      border-radius: 14px;
      padding:12px;
      background: rgba(255,255,255,.02);
      min-height:78px;
    }
    .prioTop{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
    .prioVal{ font-size:22px; font-weight:800; letter-spacing:-0.2px; }
    .prioKey{ font-size:12px; color: var(--muted); }
    .prioSub{ margin-top:6px; font-size:12px; color: var(--muted); line-height:1.25; }

    /* Reviews */
    .reviews-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:18px 0 10px;
      gap:12px;
      flex-wrap:wrap;
    }
    .review-card{
      padding:12px;
      border:1px solid var(--border);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.02);
    }
    .review-top{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .review-name{ font-weight:700; line-height:1.2; }
    .review-meta{ font-size:12px; color:var(--muted); margin-top:3px; }
    .review-stars{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color:var(--text-strong); white-space:nowrap; }
    .review-text{ margin-top:10px; font-size:13px; color:var(--text); line-height:1.35; }
    .review-link{ margin-top:10px; font-size:12px; }
    .review-link a{ color:var(--accent-strong); text-decoration:none; }
    .review-link a:hover{ text-decoration:underline; }
    .review-tags{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: var(--muted);
    }

    /* Review Insights / Trend */
    .insights{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
      margin-top: 14px;
      margin-bottom: 6px;
    }
    .insights .card{ min-height: auto; }
    canvas{
      width:100%;
      height:auto;
      display:block;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.08);
    }
    .miniGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Drawer */
    .drawer-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:stretch;
      justify-content:flex-end;
      z-index:50;
    }
    .drawer{
      width:min(560px, 92vw);
      background: linear-gradient(180deg, rgba(20,20,23,.98), rgba(12,12,15,.98));
      border-left:1px solid var(--border);
      box-shadow: 0 30px 70px rgba(0,0,0,.6);
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:14px;
      overflow:auto;
    }
    .drawer-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .drawer h2{ margin:0; font-size:18px; letter-spacing:-0.2px;}
    .drawer .muted{ color:var(--muted); font-size:12px; margin-top:4px; }
    .close{
      height:34px;
      padding:0 10px;
      border-radius:10px;
    }
    .mini{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .mini .card{
      min-height:auto;
      padding:12px;
      box-shadow:none;
      background: rgba(255,255,255,.02);
    }
    .chart{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.02);
      padding:12px;
    }
    .chart svg{ width:100%; height:160px; display:block; }
    .links a{ color:var(--accent-strong); text-decoration:none; }
    .links a:hover{ text-decoration:underline; }
    .empty{
      padding:16px;
      color:var(--muted);
      font-size:13px;
      border-radius: 12px;
    }
    .empty--loading{
      background: rgba(255,255,255,.02);
    }
    .empty--loading .empty-icon{
      display: inline-block;
      animation: spin 1.5s linear infinite;
    }
    .empty--no-data{
      background: rgba(255,255,255,.02);
    }
    .empty--error{
      background: rgba(255,80,80,.06);
      border: 1px solid rgba(255,80,80,.2);
      color: #ffd7d7;
    }
    @keyframes spin{
      from{ transform:rotate(0deg); }
      to{ transform:rotate(360deg); }
    }
    .drawerReviews{ display:flex; flex-direction:column; gap:10px; }

    .view-section{ display:none; }
    body.view-main .view-main{ display:block; }
    body.view-exec .view-exec{ display:block; }
    body.view-ops .view-ops{ display:block; }
    body.view-marketing .view-marketing{ display:block; }
    body.view-cx .view-cx{ display:block; }
    body.view-main .soften-main{ opacity:.7; }
    body.view-ops .soften-ops{ display:none; }
    body.view-cx .soften-cx{ display:none; }

    .main-dashboard{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      margin-bottom:16px;
    }
    .glance ul{ margin:8px 0 0 16px; padding:0; color:var(--text); font-size:13px; line-height:1.45; }
    .listCard{ border:1px solid var(--border); border-radius: var(--radius2); padding:12px; background: rgba(255,255,255,.02); }
    .clickable{ cursor:pointer; }
    .compare-grid{ display:grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap:10px; }
    .chip{ padding:6px 10px; border-radius:999px; border:1px solid var(--border); background: rgba(255,255,255,.02); font-size:12px; }
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:80;
    }
    .modal{
      width:min(640px, 92vw); background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: var(--shadow);
    }
    .debug details{ border:1px solid var(--border); border-radius:12px; padding:12px; background:rgba(255,255,255,.02); }
    .debug summary{ cursor:pointer; font-weight:600; }
    .debug-grid{ display:grid; grid-template-columns: repeat(2, minmax(180px, 1fr)); gap:10px; margin-top:10px; }
    .toggle{ display:flex; align-items:center; gap:8px; font-size:12px; }
    #compareSelect{ white-space:normal; max-width:360px; }
    #compareSelect option{ white-space:normal; padding:4px 8px; }
    #compareChips{ align-items:flex-start; }
    #compareChips .chip{ white-space:normal; }

    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
      .insights{ grid-template-columns: 1fr; }
      .exec-grid{ grid-template-columns: 1fr; }
      h1{ font-size:34px; }
      input{ width: 100%; min-width: 220px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>PB1 Executive Dashboard</h1>
    <div class="live-row">
      <span class="live-badge mono" id="liveBadge">LIVE: Apify → Supabase • Stores: —</span>
    </div>
    <div class="hint mono" id="scopeMeta">Scope: All Markets • Source: Apify → Supabase</div>
    <div class="hint mono" id="dataSourceMeta">Data source: LOCAL API • Last updated: —</div>

    <div class="subline" id="subline">
      <span class="pill">Loading…</span>
    </div>

    <div class="error-banner" id="errorBanner"></div>

    <div class="toolbar">

      <label class="mono">Week:
        <input id="weekAllToggle" type="checkbox" checked />
        <span>All weeks (Latest)</span>
        <input id="weekDate" type="date" disabled />
        <button id="weekPrev" class="btn-ghost" type="button">Prev</button>
        <button id="weekNext" class="btn-ghost" type="button">Next</button>
        <span class="hint mono" id="weekWindow">Week window: Latest (rolling)</span>
      </label>

      <label class="mono">State:
        <input id="stateInput" class="mono" placeholder="Illinois or IL" style="width:140px; text-transform:uppercase;" />
      </label>

      <label class="mono">City:
        <input id="cityInput" class="mono" placeholder="Chicago (optional)" style="width:160px;" />
      </label>

      <label class="mono">Shop:
        <select id="storeSelect"></select>
      </label>

      <label class="mono">View:
        <select id="viewSelect">
          <option value="main">Main Dashboard</option>
          <option value="exec">Executive</option>
          <option value="ops">Operations</option>
          <option value="marketing">Marketing</option>
          <option value="cx">Customer Experience</option>
        </select>
      </label>
      <label class="mono">Source:
        <select id="sourceSelect"></select>
      </label>

      <input id="storeSearch" class="mono" placeholder="Search shops…" />

      <label class="mono">Theme:
        <select id="themeSelect">
          <option value="dark">Potbelly Dark (Executive)</option>
          <option value="light">Potbelly Light (Executive)</option>
        </select>
      </label>

      <button id="applyBtn" class="btn-primary">Apply</button>
      <button id="reloadBtn" class="btn-ghost">Refresh</button>
      <label class="mono">Presets:
        <select id="presetSelect">
          <option value="">Select preset…</option>
        </select>
      </label>
      <button id="presetSaveBtn" class="btn-ghost">Save Preset</button>
      <button id="presetDeleteBtn" class="btn-ghost" disabled>Delete</button>
      <button id="jsonBtn" class="btn-ghost">Show JSON</button>
      <span class="hint mono" id="shopsLoaded" style="flex-basis:100%;">—</span>
    </div>

<!-- Store Profile (updates when a store is selected) -->
<div id="storeProfile" class="card" style="margin-top:14px;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
    <div style="min-width:260px;">
      <div class="mono" style="opacity:.7; font-size:12px;">Selected shop</div>
      <div id="spName" style="font-size:16px; font-weight:600; margin-top:4px;">—</div>
      <div id="spAddr" style="opacity:.85; margin-top:4px;">—</div>
      <div id="spMeta" class="mono" style="opacity:.65; font-size:12px; margin-top:6px;">
        Select a shop to view details
      </div>
    </div>

    <div style="display:flex; gap:10px; align-items:center;">
      <button id="spMaps" class="btn-ghost" disabled>Open in Maps</button>
      <button id="spCopy" class="btn-ghost" disabled>Copy address</button>
    </div>
  </div>
</div>

    <div class="card view-section view-main" id="viewHeaderMain" style="margin-top:12px;"></div>
    <div class="card view-section view-ops view-exec" id="viewHeaderWeekly" style="margin-top:12px;"></div>
    <div class="card view-section view-cx" id="viewHeaderFeedback" style="margin-top:12px;"></div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="view-section view-main">
      <div class="main-dashboard">
        <div class="card glance">
          <div class="section-title">
            <span>Executive Alerts (This Week)</span>
            <span class="hint mono" id="glanceStamp">—</span>
          </div>
          <ul id="glanceList"></ul>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button id="goTableBtn" class="btn-ghost">Open Weekly Table</button>
            <button id="goReviewsBtn" class="btn-ghost">Open Feedback</button>
            <button id="goCompareBtn" class="btn-primary">Compare Shops</button>
          </div>
        </div>
        <div class="card">
        <div class="section-title">
          <span>Top / Bottom Shops</span>
        </div>
          <div class="listCard">
            <div class="kpi-label">Top 3 (highest avg stars)</div>
            <div id="topList" class="mono" style="font-size:12px; line-height:1.4;">—</div>
          </div>
          <div class="listCard" style="margin-top:10px;">
            <div class="kpi-label">Bottom 3 (lowest avg stars)</div>
            <div id="bottomList" class="mono" style="font-size:12px; line-height:1.4;">—</div>
          </div>
        </div>
      </div>

      <div class="card clickable soften-main" id="compareCard">
        <div class="section-title">
          <span>Compare Shops (2–4)</span>
          <span class="hint">Uses loaded data only</span>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <input id="compareSearch" class="mono" placeholder="Search shops to compare…" />
          <select id="compareSelect" multiple size="4" style="min-width:280px;"></select>
          <button id="compareBtn" class="btn-primary" disabled>Compare</button>
          <button id="compareClearBtn" class="btn-ghost">Clear</button>
          <button id="compareEvidenceBtn" class="btn-ghost">View Evidence</button>
        </div>
        <div id="compareChips" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;"></div>
        <div id="compareCards" class="compare-grid" style="margin-top:12px;"></div>
      </div>
    </div>

    <!-- Executive Summary + Priority -->
    <div class="exec-grid view-section view-main view-exec">
      <div class="exec-card">
        <div class="exec-title">
          <h2>Executive Summary</h2>
          <span class="pill mono" id="summaryStamp">—</span>
        </div>
        <div class="summary" id="execSummary">Loading summary…</div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <button id="execPrimaryBtn" class="btn-primary">Open Primary Action</button>
          <button id="evidenceBtn" class="btn-ghost">View Evidence</button>
          <span class="hint" id="execPrimaryLabel">—</span>
        </div>

        <div class="badge-row" id="summaryBadges"></div>

        <div class="barWrap" style="margin-top:14px;">
          <div class="hint mono">Source mix (current review sample)</div>
          <div id="platformBars"></div>
        </div>
      </div>

      <div class="exec-card">
        <div class="exec-title">
          <h2>Priority Panel</h2>
          <span class="hint mono" id="priorityHint">—</span>
        </div>

        <div class="prioGrid">
          <div class="prioTile" id="tileWorst">
            <div class="prioTop">
              <div class="prioKey">Lowest Avg Stars</div>
              <div class="prioVal mono" id="prioWorst">—</div>
            </div>
            <div class="prioSub" id="prioWorstSub">—</div>
          </div>

          <div class="prioTile" id="tileDrop">
            <div class="prioTop">
              <div class="prioKey">Biggest Δ Stars Drop</div>
              <div class="prioVal mono" id="prioDrop">—</div>
            </div>
            <div class="prioSub" id="prioDropSub">—</div>
          </div>

          <div class="prioTile" id="tileSpike">
            <div class="prioTop">
              <div class="prioKey">Largest Δ Reviews Spike</div>
              <div class="prioVal mono" id="prioSpike">—</div>
            </div>
            <div class="prioSub" id="prioSpikeSub">—</div>
          </div>

          <div class="prioTile" id="tileNeg">
            <div class="prioTop">
              <div class="prioKey">Neg % (≤2★)</div>
              <div class="prioVal mono" id="prioNeg">—</div>
            </div>
            <div class="prioSub" id="prioNegSub">—</div>
          </div>
        </div>

        <div class="section-title" style="margin-top:14px;">
          <span>Fast Lists</span>
          <span class="hint">Click a line to filter to that shop</span>
        </div>

        <div class="miniGrid">
          <div class="card" style="box-shadow:none; background:rgba(255,255,255,.02); min-height:auto;">
            <div class="kpi-label">Action Needed (lowest avg)</div>
            <div class="mono" id="listWorst" style="font-size:12px; line-height:1.4; color:var(--text);">—</div>
          </div>
          <div class="card" style="box-shadow:none; background:rgba(255,255,255,.02); min-height:auto;">
            <div class="kpi-label">Volume Spikes (Δ reviews)</div>
            <div class="mono" id="listSpikes" style="font-size:12px; line-height:1.4; color:var(--text);">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Key Weekly KPIs -->
    <div class="section-title view-section view-main view-exec view-ops soften-ops" style="margin-top:6px;">
      <span>Weekly KPIs</span>
    </div>
    <div class="grid view-section view-main view-exec view-ops soften-ops">
      <div class="card clickable" id="kpiCardWeek">
        <div class="kpi-label">Week Ending</div>
        <div class="kpi-value mono" id="kpiWeek">—</div>
      </div>
      <div class="card clickable" id="kpiCardStores">
        <div class="kpi-label">Shops Reporting</div>
        <div class="kpi-value" id="kpiStores">—</div>
      </div>
      <div class="card clickable" id="kpiCardReviews">
        <div class="kpi-label">Total Reviews (Selected)</div>
        <div class="kpi-value" id="kpiReviews">—</div>
      </div>
      <div class="card clickable" id="kpiCardAvgStars">
        <div class="kpi-label">Avg Stars Overall (Weighted)</div>
        <div class="kpi-value" id="kpiAvgStars">—</div>
      </div>
    </div>

    <div class="view-section view-ops view-exec" id="weeklySection">
      <div class="section-title">
        <span>Weekly Performance (click a row to drill in)</span>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="sortable" data-sort="week">Week Ending</th>
              <th class="sortable" data-sort="store">Shop</th>
              <th class="sortable" data-sort="city">City</th>
              <th class="sortable" data-sort="state">State</th>
              <th class="right sortable" data-sort="total">Total Reviews</th>
              <th class="right sortable" data-sort="avg">Avg Stars</th>
              <th class="right sortable" data-sort="dReviews">Δ Reviews</th>
              <th class="right sortable" data-sort="dStars">Δ Stars</th>
              <th class="sortable" data-sort="source">Source</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="empty" id="emptyState" style="display:none;"></div>
      </div>
      <div style="margin-top:10px;">
        <button id="loadMoreBtn" class="btn-ghost" style="display:none;">Load more rows</button>
      </div>
    </div>

    <!-- Review insights + trend chart -->
    <div class="section-title view-section view-cx view-marketing view-exec" style="margin-top:18px;">
      <span>Customer Feedback Signals</span>
      <span class="hint mono">Based on Google Reviews (filtered by shop + source)</span>
    </div>

    <div class="insights view-section view-cx view-marketing view-exec">
      <div class="card">
        <div class="kpi-label">Recent Rating Trend</div>
        <div class="hint" style="margin-top:-2px;">Each point is a review (sorted by date)</div>
        <div style="margin-top:12px;">
          <canvas id="trendCanvas" width="900" height="220"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="kpi-label">Feedback KPIs</div>
        <div class="miniGrid" style="margin-top:10px;">
          <div class="card" style="box-shadow:none; background:rgba(255,255,255,.02); min-height:auto;">
            <div class="kpi-label">Total Reviews</div>
            <div class="kpi-value" id="kpiTotalReviews">—</div>
            <div class="kpi-sub" id="kpiTotalReviewsSub">—</div>
          </div>
          <div class="card" style="box-shadow:none; background:rgba(255,255,255,.02); min-height:auto;">
            <div class="kpi-label">Avg Rating</div>
            <div class="kpi-value" id="kpiAvgRating">—</div>
            <div class="kpi-sub" id="kpiAvgRatingSub">—</div>
          </div>
          <div class="card" style="box-shadow:none; background:rgba(255,255,255,.02); min-height:auto;">
            <div class="kpi-label">Last 14 Days</div>
            <div class="kpi-value" id="kpiLast14">—</div>
            <div class="kpi-sub" id="kpiLast14Sub">—</div>
          </div>
          <div class="card" style="box-shadow:none; background:rgba(255,255,255,.02); min-height:auto;">
            <div class="kpi-label">Neg % (≤2★)</div>
            <div class="kpi-value" id="kpiNegPct">—</div>
            <div class="kpi-sub" id="kpiNegPctSub">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reviews -->
    <div class="reviews-head view-section view-cx view-marketing view-exec">
      <div id="reviewsTitle" style="font-weight:700;">Recent Feedback</div>
      <div id="reviewsMeta" style="font-size:12px; color:var(--muted);"></div>
    </div>
    <div id="reviewsList" class="view-section view-cx view-marketing view-exec" style="display:flex; flex-direction:column; gap:10px;"></div>

    <div class="view-section view-marketing" style="margin-top:18px;">
      <div class="section-title">
        <span>Marketing Signals</span>
        <span class="hint">Volume + highlights</span>
      </div>
      <div class="insights">
        <div class="card">
          <div class="kpi-label">Review Volume Trend</div>
          <canvas id="marketingTrend" width="900" height="220" style="margin-top:12px;"></canvas>
        </div>
        <div class="card">
          <div class="kpi-label">5★ Highlights</div>
          <div id="marketingHighlights" class="mono" style="font-size:12px; line-height:1.4;">—</div>
          <div class="kpi-sub" id="marketingFiveStarPct">—</div>
        </div>
      </div>
    </div>

    <div class="view-section view-cx" style="margin-top:18px;">
      <div class="section-title">
        <span>Customer Experience Signals</span>
        <span class="hint">Ratings distribution + low ratings</span>
      </div>
      <div class="insights">
        <div class="card">
          <div class="kpi-label">Ratings Distribution</div>
          <canvas id="cxDist" width="900" height="220" style="margin-top:12px;"></canvas>
        </div>
        <div class="card">
          <div class="kpi-label">Low-Rated Reviews (≤3★)</div>
          <div id="cxLowReviews" class="mono" style="font-size:12px; line-height:1.4;">—</div>
          <div class="kpi-sub" id="cxActionTip">Recommended action: review response + ops follow-up</div>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="kpiModal">
      <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
          <div style="font-weight:700;" id="kpiModalTitle">KPI Detail</div>
          <button class="btn-ghost" id="kpiModalClose">Close</button>
        </div>
        <div id="kpiModalBody" style="margin-top:10px; font-size:13px; line-height:1.45;"></div>
        <div style="margin-top:12px;">
          <button class="btn-primary" id="kpiModalEvidence">Open Full Weekly Table</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="evidenceModal">
      <div class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
          <div style="font-weight:700;">Evidence</div>
          <button class="btn-ghost" id="evidenceClose">Close</button>
        </div>
        <div id="evidenceBody" style="margin-top:10px; font-size:12px; line-height:1.5;"></div>
      </div>
    </div>

    <div class="debug" style="margin-top:18px;">
      <button id="debugToggle" class="btn-ghost" style="margin-bottom:8px;">Show Debug</button>
      <div class="mono" style="font-size:11px; opacity:.7; margin-top:-2px;">UI_BUILD: 2026-01-21__LIVE_ONLY_LOCK__STEP1</div>
      <details id="debugDetails">
        <summary>Debug / Provenance</summary>
        <div class="debug-grid">
          <div class="card" style="box-shadow:none; background:rgba(255,255,255,.02); min-height:auto;">
            <div class="kpi-label">API Base</div>
            <div class="mono" id="dbgApiBase">—</div>
          </div>
          <div class="card" style="box-shadow:none; background:rgba(255,255,255,.02); min-height:auto;">
            <div class="kpi-label">Counts</div>
            <div class="mono" id="dbgCounts">—</div>
          </div>
          <div class="card" style="box-shadow:none; background:rgba(255,255,255,.02); min-height:auto;">
            <div class="kpi-label">Filters</div>
            <div class="mono" id="dbgFilters">—</div>
          </div>
          <div class="card" style="box-shadow:none; background:rgba(255,255,255,.02); min-height:auto;">
            <div class="kpi-label">Last Updated</div>
            <div class="mono" id="dbgLastUpdated">—</div>
          </div>
        </div>
        <div class="mono" style="margin-top:10px; font-size:12px; padding:10px; background:rgba(0,0,0,.2); border-radius:4px;">
          <div style="color:#0f0; font-weight:bold; margin-bottom:5px;">Request Log</div>
          <div id="dbgUrls">—</div>
        </div>
        <div class="mono" style="margin-top:10px; font-size:12px; padding:10px; background:rgba(80,0,0,.3); border-radius:4px;">
          <div style="color:#f88; font-weight:bold; margin-bottom:5px;">Last Error</div>
          <div id="dbgError" style="color:#faa;">—</div>
        </div>
        <div style="display:flex; gap:16px; flex-wrap:wrap; margin-top:10px;">
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button id="exportCsvBtn" class="btn-ghost">Export current table CSV</button>
          <button id="openExecJsonBtn" class="btn-ghost">Open exec JSON</button>
          <button id="openReviewsJsonBtn" class="btn-ghost">Open reviews JSON</button>
        </div>
      </details>
    </div>

    <!-- Drawer -->
    <div class="drawer-backdrop" id="drawerBackdrop">
      <div class="drawer" role="dialog" aria-modal="true">
        <div class="drawer-header">
          <div>
            <h2 id="drawerTitle">Shop</h2>
            <div class="muted" id="drawerSubtitle">—</div>
          </div>
          <button class="close" id="drawerClose">Close Details</button>
        </div>

        <div class="kpi-label">Weekly rollup (<span id="drawerWeeklySource">Google Reviews</span>)</div>
        <div class="mini">
          <div class="card">
            <div class="kpi-label">Latest Week Reviews</div>
            <div class="kpi-value" id="dReviews">—</div>
          </div>
          <div class="card">
            <div class="kpi-label">Latest Week Avg Stars</div>
            <div class="kpi-value" id="dAvg">—</div>
          </div>
        </div>

        <div class="chart">
          <div class="kpi-label">Last weeks (Avg Stars)</div>
          <svg id="spark" viewBox="0 0 400 160" preserveAspectRatio="none"></svg>
        </div>

        <div class="chart">
          <div class="kpi-label">Rows (this shop • filtered)</div>
          <div class="mono muted" id="dRows">—</div>
          <div class="links mono muted" id="dLinks"></div>
        </div>

        <div class="kpi-label" style="margin-top:10px;">Reviews (<span id="drawerReviewSource">Google Reviews</span>)</div>
        <div class="chart">
          <div class="kpi-label">Latest Reviews (this shop • source filter)</div>
          <div class="drawerReviews" id="drawerReviews"></div>
        </div>
      </div>
    </div>
  </div>

<script>
console.log("[PB1][BOOT] script loaded", new Date().toISOString());
  // Tiny DOM helper (you removed this earlier)
  function $(id) {
    return document.getElementById(id);
  }

  function setText(el, text){
    if (el) el.textContent = text;
  }

  function setHTML(el, html){
    if (el) el.innerHTML = html;
  }

  function showEl(el, display="block"){
    if (el) el.style.display = display;
  }

  function hideEl(el){
    if (el) el.style.display = "none";
  }

  function addListener(el, event, handler, opts){
    if (el) el.addEventListener(event, handler, opts);
  }

function getApiBase() {
  // 1. Query param override: ?api=https://example.com
  const params = new URLSearchParams(window.location.search);
  const apiParam = params.get("api");
  if (apiParam) return decodeURIComponent(apiParam).replace(/\/$/, "");

  // 2. localStorage override: localStorage.setItem("PB1_API_BASE", "https://...")
  const stored = localStorage.getItem("PB1_API_BASE");
  if (stored) return stored.replace(/\/$/, "");

  // 3. Local dev: localhost, 127.0.0.1, or file://
  const h = location.hostname;
  if (h === "localhost" || h === "127.0.0.1" || location.protocol === "file:") {
    return "http://localhost:10000";
  }

  // 4. Production default (Render.com deployment)
  return "https://pb1-t52r.onrender.com";
}

const API_BASE = getApiBase();
window.API_BASE = API_BASE; // expose for console debugging
console.log(`[PB1] API_BASE=${API_BASE}`);

// Read API token (set window.PB1_READ_TOKEN before page load if auth required)
const READ_TOKEN = window.PB1_READ_TOKEN || "";

  const DEBUG = false;
  const log = (...a) => DEBUG && console.log(...a);
  const MIN_STORES = 5;

// API_BASE is HOST ONLY (no /api), endpoints add /api prefix
const EXEC_URL    = `${API_BASE}/api/exec-weekly`;
const META_URL    = `${API_BASE}/api/meta`;
const STORES_URL  = `${API_BASE}/api/stores-apify`;
const REVIEWS_URL = `${API_BASE}/api/reviews`;
  

  const MARKET_STATE_KEY = "pb1_market_state";
  const MARKET_CITY_KEY = "pb1_market_city";
  const PRESETS_KEY = "pb1_presets_v1";

    const sublineEl = $("subline");
    const sigEl = $("sig");
    const weekAllToggle = $("weekAllToggle");
    const weekDateInput = $("weekDate");
    const weekPrevBtn = $("weekPrev");
    const weekNextBtn = $("weekNext");
    const weekWindowEl = $("weekWindow");
    const stateInput = $("stateInput");
    const cityInput = $("cityInput");
    const storeSelect = $("storeSelect");
    const sourceSelect = $("sourceSelect");
    const storeSearch = $("storeSearch");
    const viewSelect = $("viewSelect");
    const applyBtn = $("applyBtn");
    const reloadBtn = $("reloadBtn");
    const presetSelect = $("presetSelect");
    const presetSaveBtn = $("presetSaveBtn");
    const presetDeleteBtn = $("presetDeleteBtn");
    const jsonBtn = $("jsonBtn");
    const errorBanner = $("errorBanner");
    const shopsLoadedEl = $("shopsLoaded");
    const liveBadge = $("liveBadge");
    const scopeMeta = $("scopeMeta");
    const tbody = $("tbody");
    const emptyState = $("emptyState");
    const reviewsMeta = $("reviewsMeta");
    const reviewsList = $("reviewsList");
    const reviewsTitle = $("reviewsTitle");
    const dataSourceMeta = $("dataSourceMeta");
    const marketingTrend = $("marketingTrend");
    const marketingHighlights = $("marketingHighlights");
    const marketingFiveStarPct = $("marketingFiveStarPct");
    const cxDist = $("cxDist");
    const cxLowReviews = $("cxLowReviews");
    const cxActionTip = $("cxActionTip");
    const glanceList = $("glanceList");
    const glanceStamp = $("glanceStamp");
    const topList = $("topList");
    const bottomList = $("bottomList");
    const goTableBtn = $("goTableBtn");
    const goReviewsBtn = $("goReviewsBtn");
    const goCompareBtn = $("goCompareBtn");
    const compareSearch = $("compareSearch");
    const compareSelect = $("compareSelect");
    const compareBtn = $("compareBtn");
    const compareClearBtn = $("compareClearBtn");
    const compareEvidenceBtn = $("compareEvidenceBtn");
    const compareCards = $("compareCards");
    const compareChips = $("compareChips");
    const loadMoreBtn = $("loadMoreBtn");
    const kpiModal = $("kpiModal");
    const kpiModalTitle = $("kpiModalTitle");
    const kpiModalBody = $("kpiModalBody");
    const kpiModalEvidence = $("kpiModalEvidence");
    const kpiModalClose = $("kpiModalClose");
    const evidenceBtn = $("evidenceBtn");
    const evidenceModal = $("evidenceModal");
    const evidenceClose = $("evidenceClose");
    const evidenceBody = $("evidenceBody");
    const viewHeaderMain = $("viewHeaderMain");
    const viewHeaderWeekly = $("viewHeaderWeekly");
    const viewHeaderFeedback = $("viewHeaderFeedback");
    const drawerWeeklySource = $("drawerWeeklySource");
    const drawerReviewSource = $("drawerReviewSource");
    const dbgApiBase = $("dbgApiBase");
    const dbgCounts = $("dbgCounts");
    const dbgFilters = $("dbgFilters");
    const dbgLastUpdated = $("dbgLastUpdated");
    const dbgUrls = $("dbgUrls");
    const dbgError = $("dbgError");
    const debugToggle = $("debugToggle");
    const debugDetails = $("debugDetails");
    const exportCsvBtn = $("exportCsvBtn");
    const openExecJsonBtn = $("openExecJsonBtn");
    const openReviewsJsonBtn = $("openReviewsJsonBtn");
    const themeSelect = $("themeSelect");

  // ---------- Store Profile card ----------
  const storeProfile = $("storeProfile");
  const spName = $("spName");
  const spAddr = $("spAddr");
  const spMeta = $("spMeta");
  const spMaps = $("spMaps");
  const spCopy = $("spCopy");

  function mapsUrlForStore(s) {
    const q = [s?.name, s?.address, s?.city, s?.state].filter(Boolean).join(" ");
    return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
  }

  function renderStoreProfile(storeId) {
    if (!spName || !spAddr || !spMeta || !spMaps || !spCopy) return;

    if (!storeId) {
      spName.textContent = "All shops selected";
      spAddr.textContent = marketFilterLabel();
      spMeta.textContent = "Select a shop to view details";
      spMaps.disabled = true;
      spCopy.disabled = true;
      return;
    }

    const s = getStoreById(storeId) || (STORES || []).find(x => String(x.id || x.store_id || x.place_id || "") === String(storeId));
    if (!s) {
      spName.textContent = "—";
      spAddr.textContent = "—";
      spMeta.textContent = "Selected shop not found in loaded list";
      spMaps.disabled = true;
      spCopy.disabled = true;
      return;
    }

    spName.textContent = s.name || "Potbelly";
    spAddr.textContent = s.address || `${s.city || ""} ${s.state || ""}`.trim() || "—";

    const scraped = s.scraped_at ? new Date(s.scraped_at).toLocaleString() : null;
    const idText = s.id || s.place_id || s.store_id || "—";
    spMeta.textContent = `id: ${idText}${scraped ? ` · scraped: ${scraped}` : ""}`;

    spMaps.disabled = false;
    spCopy.disabled = !(s.address || s.city || s.state);

    spMaps.onclick = () => window.open(mapsUrlForStore(s), "_blank", "noopener,noreferrer");
    spCopy.onclick = async () => {
      const txt = s.address || [s.name, s.city, s.state].filter(Boolean).join(" ");
      try {
        await navigator.clipboard.writeText(txt);
        spCopy.textContent = "Copied ✓";
        setTimeout(() => (spCopy.textContent = "Copy address"), 900);
      } catch {
        // fallback (rare)
        const ta = document.createElement("textarea");
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        spCopy.textContent = "Copied ✓";
        setTimeout(() => (spCopy.textContent = "Copy address"), 900);
      }
    };
  }

  function setView(view){
    const v = view || "main";
    document.body.classList.remove("view-main","view-exec","view-ops","view-marketing","view-cx");
    document.body.classList.add(`view-${v}`);
    if (viewSelect) viewSelect.value = v;
  }

  function updateDebugPanel(){
    if (dbgApiBase) setText(dbgApiBase, API_BASE);
    if (dbgCounts) setText(dbgCounts, `shops=${STORES_ALL.length} • weekly=${LAST_EXEC?.records ?? 0} • reviews=${safeNum(LAST_REVIEWS?.records, 0)}`);
    if (dbgFilters) {
      const state = MARKET_FILTERS.state || "—";
      const city = MARKET_FILTERS.city || "—";
      setText(dbgFilters, `state=${state} • city=${city}`);
    }
   if (dbgUrls) {
  const U = (typeof LAST_URLS === "object" && LAST_URLS) ? LAST_URLS : {};
  const urls = [
    U.meta    ? `meta=${U.meta}`       : null,
    U.stores  ? `stores=${U.stores}`   : null,
    U.metrics ? `metrics=${U.metrics}` : null,
    U.weekly  ? `weekly=${U.weekly}`   : null,
    U.reviews ? `reviews=${U.reviews}` : null,
  ].filter(Boolean).join(" | ");
  setText(dbgUrls, urls || "—");
}
updateScopeMeta();
syncDebugToggle();

  function updateDataSourceMeta(lastUpdated){
    if (!dataSourceMeta) return;
    const stamp = lastUpdated ? new Date(lastUpdated) : null;
    const text = stamp ? stamp.toLocaleString() : "—";
    const apiLabel = API_BASE.includes("localhost") ? "LOCAL" : "PROD";
    setText(dataSourceMeta, `Data source: ${apiLabel} (${API_BASE}) • Last updated: ${text}`);
  }
  function updateLiveBadge(count){
    if (!liveBadge) return;
    const safeCount = Number.isFinite(count) ? count : 0;
    const city = (MARKET_FILTERS.city || "").trim();
    const stateLabel = formatStateLabel(MARKET_FILTERS.state);
    const shortState = stateLabel === "Illinois" ? "IL" : stateLabel;
    const market = [city, shortState].filter(Boolean).join(", ") || "All Markets";
    setText(liveBadge, `LIVE: Apify → Supabase (${market}) • Stores: ${fmt(safeCount)}`);
  }


    // Summary/priority
    const execSummaryEl = $("execSummary");
    const summaryStampEl = $("summaryStamp");
    const summaryBadgesEl = $("summaryBadges");
    const platformBarsEl = $("platformBars");
    const execPrimaryBtn = $("execPrimaryBtn");
    const execPrimaryLabel = $("execPrimaryLabel");

    const priorityHintEl = $("priorityHint");
    const prioWorst = $("prioWorst");
    const prioWorstSub = $("prioWorstSub");
    const prioDrop = $("prioDrop");
    const prioDropSub = $("prioDropSub");
    const prioSpike = $("prioSpike");
    const prioSpikeSub = $("prioSpikeSub");
    const prioNeg = $("prioNeg");
    const prioNegSub = $("prioNegSub");

    const listWorst = $("listWorst");
    const listSpikes = $("listSpikes");

    // Insight elements
    const trendCanvas = $("trendCanvas");
    const kpiTotalReviews = $("kpiTotalReviews");
    const kpiAvgRating = $("kpiAvgRating");
    const kpiLast14 = $("kpiLast14");
    const kpiNegPct = $("kpiNegPct");
    const kpiTotalReviewsSub = $("kpiTotalReviewsSub");
    const kpiAvgRatingSub = $("kpiAvgRatingSub");
    const kpiLast14Sub = $("kpiLast14Sub");
    const kpiNegPctSub = $("kpiNegPctSub");

    let META = null;
    let STORES = [];
    let STORES_ALL = [];
    window.STORES_ALL = STORES_ALL; // expose for console debugging
    let LAST_EXEC = null;
    let LAST_REVIEWS = null;
    let LAST_METRICS = null;
    let TABLE_LIMIT = 200;
    let DUPLICATE_IDS_FOUND = false;
    let APPLY_INFLIGHT = false;
    let CURRENT_WEEK_LABEL = "Latest (all weeks)";
    let TABLE_COMPARE_FILTER = null;
    let STORES_LOGGED = false;
    let MARKET_FILTERS = { state: null, city: null };
    let LAST_URLS = {
      meta: null,
      stores: null,
      metrics: null,
      weekly: null,
      reviews: null,
      debug: null
    };

    // Table sorting state
    let sortKey = "avg";
    let sortDir = "asc"; // asc/desc

    function showError(msg){
      if (!errorBanner) return;
      errorBanner.classList.remove("warn");
      showEl(errorBanner, "block");
      setText(errorBanner, msg);
      // Auto-open debug panel on error
      const details = $("debugDetails");
      if (details && !details.open) details.open = true;
    }
    function showWarning(msg){
      if (!errorBanner) return;
      errorBanner.classList.add("warn");
      showEl(errorBanner, "block");
      setText(errorBanner, msg);
    }
    function clearError(){
      if (!errorBanner) return;
      errorBanner.classList.remove("warn");
      hideEl(errorBanner);
      setText(errorBanner, "");
    }
    function setLoadingState(msg){
      showEl(emptyState, "block");
      emptyState.className = "empty empty--loading";
      setHTML(emptyState, `<span class="empty-icon">⟳</span> ${escapeHtml(msg || "Loading weekly data…")}`);
      if (tbody) setHTML(tbody, "");
    }
    function setEmptyState(msg){
      showEl(emptyState, "block");
      emptyState.className = "empty empty--no-data";
      setHTML(emptyState, `◌ ${escapeHtml(msg || "No data found for this filter.")} <span class="hint">Try adjusting your market filters.</span>`);
      if (tbody) setHTML(tbody, "");
    }
    function setErrorState(msg){
      showEl(emptyState, "block");
      emptyState.className = "empty empty--error";
      setHTML(emptyState, `⚠ ${escapeHtml(msg || "An error occurred while loading data.")}`);
      if (tbody) setHTML(tbody, "");
    }

    function safeNum(v, fallback=0){
      const x = Number(v);
      return Number.isFinite(x) ? x : fallback;
    }
    function fmt(n){
      const x = Number(n);
      if (Number.isNaN(x)) return "—";
      return x.toLocaleString();
    }
    function fmt2(n){
      const x = Number(n);
      if (Number.isNaN(x)) return "—";
      return x.toFixed(2);
    }
    function normalizeState(s){
      if (!s) return "";
      const t = String(s).trim();
      if (t.length === 2) return t.toUpperCase();
      return t;
    }
    function formatStateLabel(s){
      const t = normalizeState(s);
      if (!t) return "";
      if (t.length === 2) return t.toUpperCase();
      return t.charAt(0).toUpperCase() + t.slice(1).toLowerCase();
    }
    function isApifySource(s){
      return String(s ?? "").toLowerCase().includes("apify");
    }
    function displaySourceName(src){
      const v = String(src ?? "").toLowerCase();
      if (!v) return "Unknown";
      if (v.includes("apify") || v.includes("google")) return "Google Reviews";
      if (v.includes("yelp")) return "Yelp";
      if (v.includes("facebook")) return "Facebook";
      return v.replace(/_/g, " ").replace(/\b\w/g, (m) => m.toUpperCase());
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function stars(n){
      const r = Math.max(0, Math.min(5, Number(n) || 0));
      return "★★★★★".slice(0, r) + "☆☆☆☆☆".slice(0, 5 - r);
    }
    function parseDateSafe(d){
      if (!d) return null;
      const t = Date.parse(d);
      return Number.isFinite(t) ? new Date(t) : null;
    }
    function addDaysIso(dateStr, days){
      const d = new Date(`${dateStr}T00:00:00Z`);
      if (Number.isNaN(d.getTime())) return "";
      d.setUTCDate(d.getUTCDate() + days);
      return d.toISOString().slice(0, 10);
    }
    function snapToMetaWeek(dateStr){
      if (!dateStr) return "";
      const weeks = (META?.weeks || []).filter(Boolean).slice().sort();
      if (!weeks.length) return dateStr;
      if (weeks.includes(dateStr)) return dateStr;
      const target = Date.parse(`${dateStr}T00:00:00Z`);
      if (!Number.isFinite(target)) return "";
      let candidate = "";
      for (const w of weeks){
        const t = Date.parse(`${w}T00:00:00Z`);
        if (!Number.isFinite(t)) continue;
        if (t <= target) candidate = w;
        else break;
      }
      return candidate || weeks[0];
    }
    function isAllWeeksSelected(){
      return weekAllToggle ? !!weekAllToggle.checked : true;
    }
    function getSelectedWeek(){
      if (isAllWeeksSelected()) return "";
      const raw = weekDateInput ? weekDateInput.value : "";
      return raw ? snapToMetaWeek(raw) : "";
    }
    function hasAnyReviews(){
      return safeNum(LAST_REVIEWS?.records, 0) > 0;
    }
    function syncWeekControls(preferredWeek){
      if (!weekAllToggle || !weekDateInput) return;
      weekDateInput.disabled = !!weekAllToggle.checked;
      if (weekPrevBtn) weekPrevBtn.disabled = !!weekAllToggle.checked;
      if (weekNextBtn) weekNextBtn.disabled = !!weekAllToggle.checked;
      if (weekAllToggle.checked) {
        weekDateInput.value = "";
        return;
      }
      const candidate =
        preferredWeek ||
        (LAST_EXEC && LAST_EXEC.week_ending) ||
        (META?.weeks || [])[0] ||
        "";
      if (candidate) weekDateInput.value = snapToMetaWeek(candidate);
    }
    function updateWeekWindowLabel(){
      if (!weekWindowEl) return;
      const selected = getSelectedWeek();
      if (!selected) {
        setText(weekWindowEl, "Week window: Latest (rolling)");
        return;
      }
      const end = addDaysIso(selected, 6);
      setText(weekWindowEl, `Week window: ${selected} \u2192 ${end || "—"}`);
    }
    function updateWeekNavButtons(){
      if (!weekPrevBtn || !weekNextBtn) return;
      if (isAllWeeksSelected()) {
        weekPrevBtn.disabled = true;
        weekNextBtn.disabled = true;
        return;
      }
      const weeks = (META?.weeks || []).filter(Boolean).slice().sort();
      const current = getSelectedWeek();
      const idx = weeks.indexOf(current);
      weekPrevBtn.disabled = idx <= 0;
      weekNextBtn.disabled = idx === -1 || idx >= weeks.length - 1;
    }
    function normalizeName(s){
      return String(s ?? "").toLowerCase().replace(/\s+/g, " ").trim();
    }
    function normalizeField(v){
      return String(v || "").trim().toLowerCase();
    }
    function isChicagoOrIllinois(row){
      const city = normalizeField(row?.city);
      const state = normalizeField(row?.state);
      return city === "chicago" || state === "illinois" || state === "il";
    }
    function getMarketFiltersFromInputs(){
      const stateRaw = (stateInput?.value || "").trim();
      const cityRaw = (cityInput?.value || "").trim();
      return {
        state: stateRaw ? stateRaw.toUpperCase() : null,
        city: cityRaw || null
      };
    }
    function marketFilterLabel(){
      const state = formatStateLabel(MARKET_FILTERS.state);
      const city = (MARKET_FILTERS.city || "").trim();
      if (state || city) {
        return `Market filter: ${state || "—"}${city ? ` / ${city}` : ""}`;
      }
      return "Market filter: none";
    }
    function updateScopeMeta(){
      if (!scopeMeta) return;
      const city = (MARKET_FILTERS.city || "").trim();
      const stateLabel = formatStateLabel(MARKET_FILTERS.state);
      const shortState = stateLabel === "Illinois" ? "IL" : stateLabel;
      const scope = [city, shortState].filter(Boolean).join(", ") || "All markets";
      setText(scopeMeta, `Scope: ${scope} • Source: Apify → Supabase`);
    }
   function syncDebugToggle(){
  if (!debugToggle || !debugDetails) return;
  debugToggle.textContent = debugDetails.open ? "Hide Debug" : "Show Debug";
}

function normalizeStateForApi(v){
  v = String(v || "").trim();
  if (!v) return "";
  if (v.length <= 2) return v.toUpperCase();
  return v.charAt(0).toUpperCase() + v.slice(1).toLowerCase();
}


function setMarketFiltersInInputs(filters){
  if (stateInput) stateInput.value = normalizeStateForApi(filters?.state || "");
  if (cityInput) cityInput.value = filters?.city || "";
}

function loadMarketFiltersFromStorage(){
  const rawState = (localStorage.getItem(MARKET_STATE_KEY) || "").trim();
  const city = (localStorage.getItem(MARKET_CITY_KEY) || "").trim();
  const state = normalizeStateForApi(rawState);
  return { state: state || null, city: city || null };
}

    function loadMarketFiltersFromUrl(){
  const params = new URLSearchParams(window.location.search);
  const rawState = (params.get("state") || "").trim();
  const city = (params.get("city") || "").trim();
  const state = normalizeStateForApi(rawState);
  return { state: state || null, city: city || null };
}

    function persistMarketFilters(filters){
      const state = filters?.state || "";
      const city = filters?.city || "";
      if (state) localStorage.setItem(MARKET_STATE_KEY, state);
      else localStorage.removeItem(MARKET_STATE_KEY);
      if (city) localStorage.setItem(MARKET_CITY_KEY, city);
      else localStorage.removeItem(MARKET_CITY_KEY);

      const params = new URLSearchParams(window.location.search);
      if (state) params.set("state", state);
      else params.delete("state");
      if (city) params.set("city", city);
      else params.delete("city");
      const next = `${location.pathname}${params.toString() ? `?${params}` : ""}`;
      history.replaceState({}, "", next);
    }
    function loadPresets(){
      try {
        const raw = localStorage.getItem(PRESETS_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }
    function savePresets(list){
      localStorage.setItem(PRESETS_KEY, JSON.stringify(list || []));
    }
    function refreshPresetUI(){
      if (!presetSelect) return;
      const list = loadPresets();
      const current = presetSelect.value || "";
      presetSelect.innerHTML = `<option value="">Select preset…</option>`;
      for (const p of list) {
        const opt = document.createElement("option");
        opt.value = p.name;
        opt.textContent = p.name;
        presetSelect.appendChild(opt);
      }
      presetSelect.value = list.some(p => p.name === current) ? current : "";
      if (presetDeleteBtn) presetDeleteBtn.disabled = !presetSelect.value;
    }
    function getCurrentPresetState(){
      return {
        state: MARKET_FILTERS.state || "",
        city: MARKET_FILTERS.city || "",
        shop: storeSelect?.value || "",
        week: getSelectedWeek() || "latest",
        view: viewSelect?.value || "main",
        theme: themeSelect?.value || "",
        source: sourceSelect?.value || ""
      };
    }
    function applyPreset(preset){
      if (!preset) return;
      const state = (preset.state || "").toString();
      const city = (preset.city || "").toString();
      MARKET_FILTERS = { state, city };
      setMarketFiltersInInputs(MARKET_FILTERS);
      if (viewSelect) viewSelect.value = preset.view || "main";
      setView(viewSelect?.value || "main");
      if (themeSelect && preset.theme) {
        themeSelect.value = preset.theme;
        document.body.setAttribute("data-theme", preset.theme);
        localStorage.setItem("pb1_theme", preset.theme);
      }
      if (sourceSelect && preset.source && [...sourceSelect.options].some(o => o.value === preset.source)) {
        sourceSelect.value = preset.source;
      }
      if (weekAllToggle && weekDateInput) {
        if (!preset.week || preset.week === "latest") {
          weekAllToggle.checked = true;
          syncWeekControls();
        } else {
          weekAllToggle.checked = false;
          syncWeekControls(preset.week);
        }
        updateWeekNavButtons();
        updateWeekWindowLabel();
      }
      if (storeSelect) {
        const desired = preset.shop || "";
        storeSelect.value = [...storeSelect.options].some(o => o.value === desired) ? desired : "";
      }
      runApply();
    }
    function buildMarketQuery(filters){
      const qs = new URLSearchParams();
      if (filters?.state) qs.set("state", normalizeStateForApi(filters.state));
      if (filters?.city) qs.set("city", filters.city);
      return qs;
    }

   const FETCH_CACHE = new Map();
   const INFLIGHT = new Map();
   const REQUEST_LOG = [];
   function logRequest(tag, url, status, error = null) {
     const stamp = new Date().toISOString().split('T')[1].slice(0,12);
     const entry = { tag, url, status, error, stamp };
     REQUEST_LOG.push(entry);
     if (REQUEST_LOG.length > 20) REQUEST_LOG.shift();
     console.log(`[PB1][${tag}] ${status} -> ${url}`, error || '');
     updateDebugUrls();
     if (error) {
       if (dbgError) setText(dbgError, `[${stamp}] ${tag}: ${error}`);
     }
   }
   function updateDebugUrls() {
     if (!dbgUrls) return;
     const lines = REQUEST_LOG.slice(-10).reverse().map(e => {
       const color = e.error ? '#f88' : (e.status >= 200 && e.status < 300 ? '#0f0' : '#fa0');
       const shortUrl = e.url.replace(API_BASE, '').slice(0, 80);
       return `<div style="color:${color};">[${e.stamp}] ${e.tag}: ${e.status} ${shortUrl}</div>`;
     }).join('');
     setHTML(dbgUrls, lines || '—');
   }
   async function fetchJSON(url, { ttl = 60000 } = {}) {
    const tag = url.includes('/meta') ? 'META' : url.includes('/stores') ? 'STORES' : url.includes('/exec-weekly') ? 'WEEKLY' : url.includes('/reviews') ? 'REVIEWS' : 'API';
    const now = Date.now();
    const cached = FETCH_CACHE.get(url);
    if (cached && (now - cached.t) < ttl) {
      logRequest(tag, url, 'CACHED');
      return cached.v;
    }

    const prev = INFLIGHT.get(url);
    if (prev) prev.abort();
    const ctrl = new AbortController();
    INFLIGHT.set(url, ctrl);

    const headers = {};
    if (READ_TOKEN) headers["X-Read-Token"] = READ_TOKEN;

    let res;
    try {
      res = await fetch(url, { cache: "no-store", signal: ctrl.signal, headers });
    } catch (e) {
      INFLIGHT.delete(url);
      const errMsg = `API unreachable: ${url}. If local, confirm backend running on :10000.`;
      logRequest(tag, url, 'FAIL', errMsg);
      throw new Error(errMsg);
    }
    INFLIGHT.delete(url);
    const text = await res.text();
    if (!res.ok) {
      let message = text;
      try {
        const parsed = JSON.parse(text);
        message = parsed?.error?.message || parsed?.error || parsed?.message || message;
      } catch {}
      const errMsg = `HTTP ${res.status} ${message ? `• ${message}` : ""}`;
      logRequest(tag, url, res.status, errMsg);
      throw new Error(`${errMsg} (${url})`);
    }
    if (!text) {
      const errMsg = `Empty JSON response for ${url}`;
      logRequest(tag, url, res.status, errMsg);
      throw new Error(errMsg);
    }
    let parsed;
    try {
      parsed = JSON.parse(text);
    } catch (e) {
      const errMsg = `Invalid JSON for ${url}`;
      logRequest(tag, url, res.status, errMsg);
      throw new Error(errMsg);
    }
    logRequest(tag, url, res.status);
    FETCH_CACHE.set(url, { t: now, v: parsed });
    return parsed;
  }

  function debounce(fn, delay = 200){
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }

    function currentSource(){
      return (sourceSelect && sourceSelect.value) ? sourceSelect.value : "apify";
    }


    function setSubline({ ok, last_updated, records, viewingLabel }){
      if (!sublineEl) return;
      setHTML(sublineEl, "");
      const stamp = last_updated ? new Date(last_updated) : new Date();
      const a = document.createElement("span");
      a.className = "pill";
      setText(a, ok ? "Data OK" : "Data Issue");

      const b = document.createElement("span");
      b.className = "pill mono";
      setText(b, `Updated: ${stamp.toLocaleString()}`);

      const c = document.createElement("span");
      c.className = "pill mono";
      setText(c, `Weekly records: ${fmt(records ?? 0)}`);

      const d = document.createElement("span");
      d.className = "pill mono";
      setText(d, `Viewing: ${viewingLabel || "All shops"}`);

      sublineEl.append(a,b,c,d);
    }

    function populateSelect(select, items, { valueFn, labelFn, includeAllLabel } = {}){
      if (!select) return;
      setHTML(select, "");
      if (includeAllLabel){
        const opt = document.createElement("option");
        opt.value = "";
        setText(opt, includeAllLabel);
        select.appendChild(opt);
      }
      for (const it of items){
        const opt = document.createElement("option");
        opt.value = valueFn ? valueFn(it) : it;
        setText(opt, labelFn ? labelFn(it) : it);
        select.appendChild(opt);
      }
    }

    // Shop label for /api/stores-apify rows
    function storeLabel(s){
      if (s?.label) return String(s.label);
      const name = s?.name || s?.store_name || s?.place_name || "Unknown Shop";
      const address = s?.address || s?.street || "";
      const city = s?.city || "";
      const state = normalizeState(s?.state || "");
      const parts = [name, address, city, state].filter(Boolean);
      return parts.join(" • ");
    }
    function getStoreById(id){
      const target = String(id || "");
      if (!target) return null;
      return (STORES_ALL || []).find(s => String(s.id || s.store_id || s.place_id || "") === target) || null;
    }

    function rowStoreText(row){
      const name = row.store ?? row.store_name ?? row.place_name ?? "Shop";
      const city = row.city ?? "";
      const state = normalizeState(row.state ?? "");
      const src = (row.source ?? "").toString();
      const base = [name, city, state].filter(Boolean).join(" • ");
      return src ? `${base} • ${displaySourceName(src)}` : base;
    }

    function dedupeStores(list){
      const seen = new Set();
      return (list || []).filter(s => {
        const key = (s.id || s.store_id || "") + "|" + storeLabel(s);
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }


    function scanDuplicateIds(list){
      const seen = new Set();
      const dupes = new Set();
      for (const s of list || []) {
        const id = s.id || s.place_id || s.store_id || "";
        if (!id) continue;
        if (seen.has(id)) dupes.add(id);
        seen.add(id);
      }
      return [...dupes];
    }

    function refreshStoreSelect(){
      if (!storeSelect) return;
      const prev = storeSelect.value;
      populateSelect(storeSelect, STORES, {
        includeAllLabel: "All shops",
        valueFn: (s) => s.id || s.store_id || "",
        labelFn: (s) => storeLabel(s)
      });
      if ([...storeSelect.options].some(o => o.value === prev)) storeSelect.value = prev;
      if (compareSelect) {
        const list = STORES_ALL || [];
        populateSelect(compareSelect, list, {
          valueFn: (s) => s.id || s.store_id || s.place_id || "",
          labelFn: (s) => storeLabel(s)
        });
      }
    }

    function applyCompareSearch(){
      if (!compareSearch || !compareSelect) return;
      const q = (compareSearch.value || "").trim().toLowerCase();
      const list = q
        ? (STORES_ALL || []).filter(s => storeLabel(s).toLowerCase().includes(q)).slice(0, 400)
        : (STORES_ALL || []);
      const prev = [...compareSelect.selectedOptions].map(o => o.value);
      populateSelect(compareSelect, list, {
        valueFn: (s) => s.id || s.store_id || s.place_id || "",
        labelFn: (s) => storeLabel(s)
      });
      for (const v of prev){
        const opt = [...compareSelect.options].find(o => o.value === v);
        if (opt) opt.selected = true;
      }
      renderCompare();
    }

    function restrictStoresToExecRows(rows){
      const ids = new Set((rows || []).map(r => r.store_id).filter(Boolean));
      if (!ids.size) return;
      // APIFY_ONLY_LOCK
      STORES = STORES.filter(s => ids.has(s.id || s.store_id));
    }

    async function loadStores(){
      const qs = buildMarketQuery(MARKET_FILTERS);
      qs.set("limit", "500");
      const url = qs.toString() ? `${STORES_URL}?${qs.toString()}` : STORES_URL;
      LAST_URLS.stores = url;
      log(`GET ${url}`);
      const json = await fetchJSON(url);
      if (!json.ok) throw new Error(json.error || "shops failed");
      // Load stores from /api/stores-apify (server-side filters applied via MARKET_FILTERS)
      STORES_ALL = (json.rows || []).sort((a,b) => {
        const ak = normalizeField(a.address || a.name);
        const bk = normalizeField(b.address || b.name);
        return ak.localeCompare(bk);
      });
      window.STORES_ALL = STORES_ALL; // sync to window for debugging
      updateLiveBadge(STORES_ALL.length);
      console.info(`[PB1][STORES] Loaded ${STORES_ALL.length} stores from ${url}`);
      const dupes = scanDuplicateIds(STORES_ALL);
      if (dupes.length) {
        DUPLICATE_IDS_FOUND = true;
        showError(`Duplicate shop IDs detected (${dupes.length}). Fix data to proceed.`);
        return { clearedStore: false, aborted: true };
      }

      STORES = dedupeStores(STORES_ALL);

      // IMPORTANT: do NOT restrict to exec rows (it can wipe stores)
      // if (LAST_EXEC?.rows?.length) restrictStoresToExecRows(LAST_EXEC.rows);

      // Repopulate dropdown exactly once
      refreshStoreSelect();
      if (storeSelect) storeSelect.disabled = STORES.length === 0;

      if (!STORES_LOGGED && DEBUG) {
        log(`STORES SOURCE: stores (count: ${STORES_ALL.length})`, STORES_ALL[0]);
        STORES_LOGGED = true;
      }
      renderStoreProfile(storeSelect ? storeSelect.value : "");
      renderCompare();
      updateDebugPanel();
      const prev = storeSelect ? storeSelect.value : "";
      if (storeSelect && prev && !STORES.some(s => (s.id || s.store_id) === prev)) {
        storeSelect.value = "";
        return { clearedStore: true };
      }
      if (shopsLoadedEl) {
        const label = STORES_ALL.length
          ? `Shops loaded: ${fmt(STORES_ALL.length)}`
          : "No data found for this filter.";
        setText(shopsLoadedEl, label);
      }
      return { clearedStore: false };
    }

    async function loadMeta({ preferredWeek } = {}){
      LAST_URLS.meta = META_URL;
      log(`GET ${META_URL}`);
      const json = await fetchJSON(META_URL);
      if (!json.ok) throw new Error(json.error || "meta failed");
      META = json;
      updateDataSourceMeta(json.last_updated);
      console.info("META fetch", { url: META_URL, weeks: (json.weeks || []).length });

      const current = preferredWeek ?? getSelectedWeek();
      syncWeekControls(current);
      updateWeekNavButtons();
      updateWeekWindowLabel();
      if (sourceSelect) {
        sourceSelect.innerHTML = "";
        sourceSelect.disabled = true;
        sourceSelect.value = "";
      }
    }

    async function loadMetrics(){
      const qs = buildMarketQuery(MARKET_FILTERS);
      const url = qs.toString() ? `${EXEC_URL}?${qs.toString()}` : EXEC_URL;

      LAST_URLS.metrics = url;
      log(`GET ${url}`);
      const json = await fetchJSON(url);
      if (!json.ok) throw new Error(json.error || "metrics failed");
      LAST_METRICS = json;
      if (dbgLastUpdated) setText(dbgLastUpdated, json.last_updated || "—");
      updateDataSourceMeta(json.last_updated);
      console.info("METRICS fetch", { url, stores: json.stores, reviews: json.reviews, weekly: json.exec_weekly_rows });
      return json;
    }

    async function loadDebug(){
      return; // debug endpoint removed; keep UI-only debug panel
    }

    function isValidExecRow(row){
      return !!row;
    }

    async function countExecRowsForWeek(week){
      const qs = new URLSearchParams();
      if (week) qs.set("week", week);
      qs.set("source", "apify");
      qs.set("limit", "2000");
      if (MARKET_FILTERS.state) qs.set("state", MARKET_FILTERS.state);
      const url = `${EXEC_URL}?${qs.toString()}`;
      LAST_URLS.weekly = url;
      log(`validate week: ${url}`);
      const json = await fetchJSON(url);
      const rows = (json.rows || []).filter(isValidExecRow);
      return rows.length;
    }

    async function chooseDefaultWeek(weeks){
      if (!weeks.length) return "";
      for (const week of weeks){
        const count = await countExecRowsForWeek(week);
        log(`week=${week} rows=${count}`);
        if (count >= MIN_STORES) return week;
      }
      return weeks[0] || "";
    }

    async function ensureDefaultWeek(){
      const weeks = META?.weeks || [];
      if (!weeks.length || !weekDateInput || isAllWeeksSelected()) return;
      if (weekDateInput.value && weeks.includes(weekDateInput.value)) return;
      setLoadingState("Selecting default week…");
      const chosen = await chooseDefaultWeek(weeks);
      weekDateInput.value = chosen || "";
      updateWeekNavButtons();
      updateWeekWindowLabel();
    }

    function applyStoreSearch(){
      if (!storeSearch || !storeSelect) return;
      const q = (storeSearch.value || "").trim().toLowerCase();
      const list = q
        ? STORES.filter(s => {
            const label = storeLabel(s).toLowerCase();
            const name  = (s.name || "").toLowerCase();
            const city  = (s.city || "").toLowerCase();
            const state = (s.state || "").toLowerCase();
            return label.includes(q) || name.includes(q) || city.includes(q) || state.includes(q);
          }).slice(0, 400)
        : STORES;

      const prev = storeSelect.value;
      populateSelect(storeSelect, list, {
        includeAllLabel: "All shops",
        valueFn: (s) => s.id || s.store_id || "",
        labelFn: (s) => storeLabel(s)
      });
      if ([...storeSelect.options].some(o => o.value === prev)) storeSelect.value = prev;
    }

    // Unified dashboard loader
    function computeExecKpis(rows){
      const storeIds = new Set();
      let totalReviews = 0;
      let weightedSum = 0;
      let avgSum = 0;
      let avgCount = 0;
      for (const r of rows || []){
        const tr = safeNum(r.total_reviews ?? r.total, 0);
        const ar = safeNum(r.avg_stars ?? r.avg_rating ?? r.avg, 0);
        totalReviews += tr;
        weightedSum += ar * tr;
        if (Number.isFinite(ar)) {
          avgSum += ar;
          avgCount += 1;
        }
        if (r.store_id) storeIds.add(r.store_id);
      }
      const avgOverall = totalReviews > 0
        ? (weightedSum / totalReviews)
        : (avgCount ? (avgSum / avgCount) : 0);
      return {
        stores_reporting: storeIds.size,
        total_reviews: totalReviews,
        avg_stars_overall: Number(avgOverall.toFixed(2))
      };
    }

    async function loadDashboard({ store, week } = {}){
      const storeId = store ?? (storeSelect ? storeSelect.value : "");
      const weekVal = week ?? getSelectedWeek();
    const source = currentSource();
      const state = MARKET_FILTERS.state;
      const city = MARKET_FILTERS.city;

      const qs = new URLSearchParams();
      if (weekVal) qs.set("week", weekVal);
      if (storeId) qs.set("store", storeId);
      if (source) qs.set("source", source);
      if (state) qs.set("state", state);
      if (city) qs.set("city", city);
      qs.set("limit", "5000");

      qs.delete("city"); // exec_weekly has no city; prevents 0-row wipeout
      const url = qs.toString() ? `${EXEC_URL}?${qs.toString()}` : EXEC_URL;

      LAST_URLS.weekly = url;
      log(`GET ${url}`);
      const json = await fetchJSON(url);
      if (!json.ok) throw new Error(json.error || "exec-weekly failed");
      console.info("WEEKLY fetch", { url, records: (json.rows || []).length });
      const validRows = (json.rows || []).filter(isValidExecRow); // APIFY_ONLY_LOCK
      const kpiSafe = computeExecKpis(validRows);
      const execJson = { ...json, rows: validRows, records: validRows.length, kpis: { ...(json.kpis || {}), ...kpiSafe } };
      LAST_EXEC = execJson;
      updateDataSourceMeta(execJson.last_updated || json.last_updated);
      // do not repopulate store dropdown from exec-weekly

      setText(sigEl, `signature: ${execJson.signature || "—"}`);

      let viewingLabel = "All shops";
      if (storeId){
        const selected = getStoreById(storeId);
        if (selected) viewingLabel = selected.name || "Selected shop";
      }

      setSubline({
        ok: !!execJson.ok,
        last_updated: execJson.last_updated || new Date().toISOString(),
        records: execJson.records ?? 0,
        viewingLabel
      });

      const k = execJson.kpis || {};
      const weekLabel = CURRENT_WEEK_LABEL
        || (isAllWeeksSelected() ? "Latest (all weeks)" : (LAST_EXEC?.week_ending || getSelectedWeek() || "—"));
      setText($("kpiWeek"), weekLabel);
      setText($("kpiStores"), fmt(k.stores_reporting ?? 0));
      setText($("kpiReviews"), fmt(k.total_reviews ?? 0));
      setText($("kpiAvgStars"), fmt2(k.avg_stars_overall ?? 0));

      // Table render with sorting
      renderTable(execJson.rows || []);

      // Priority panel derived from weekly rollup
      renderPriorityPanel(execJson);
    }

    function normalizeRow(r){
      return {
        raw: r,
        week: r.week_ending ?? r.week ?? "",
        store: r.store ?? r.store_name ?? r.place_name ?? "",
        city: r.city ?? "",
        state: r.state ?? "",
        total: safeNum(r.total_reviews ?? r.total, 0),
        avg: safeNum(r.avg_stars ?? r.avg_rating, 0),
        dReviews: safeNum(r.delta_reviews ?? r.delta_total_reviews ?? r.rating_change, 0),
        dStars: safeNum(r.delta_stars ?? r.delta_avg_stars, 0),
        source: (r.source ?? "").toString()
      };
    }

    function findStoreMatchByRow(row){
      const name = (row.store || row.store_name || row.place_name || "").toString().toLowerCase();
      const city = (row.city || "").toString().toLowerCase();
      const state = (row.state || "").toString().toLowerCase();
      return (STORES_ALL || []).find(s => {
        const sn = (s.name || "").toString().toLowerCase();
        const sc = (s.city || "").toString().toLowerCase();
        const ss = (s.state || "").toString().toLowerCase();
        return sn === name && sc === city && ss === state;
      }) || null;
    }

    function selectStoreFromRow(row){
      const match = findStoreMatchByRow(row);
      if (match && storeSelect) {
        const sid = match.id || match.place_id || match.store_id || "";
        if (sid && [...storeSelect.options].some(o => o.value === sid)) {
          storeSelect.value = sid;
        }
        renderStoreProfile(storeSelect.value || sid);
      }
      openDrawer(row);
    }

    function renderMainDashboard(execJson, reviewsJson){
      if (!glanceList || !topList || !bottomList) return;
      let rows = (execJson?.rows || []).map(normalizeRow);
      rows = rows.filter(r => r.avg > 0 && (r.store || r.raw?.store_id));
      const k = execJson?.kpis || {};
      const storesReporting = safeNum(k.stores_reporting, 0);
      const totalReviews = safeNum(k.total_reviews, 0);
      const avgStars = safeNum(k.avg_stars_overall, 0);
      const reviewRows = (LAST_REVIEWS?.rows || reviewsJson?.rows || []);
      const rated = reviewRows.map(r => safeNum(r.rating ?? r.stars, 0)).filter(x => x > 0);
      const negCount = rated.filter(x => x <= 2).length;
      const negPct = rated.length ? Math.round((negCount / rated.length) * 100) : 0;
      const weeklyCount = safeNum(execJson?.records, 0);
      const reviewCount = safeNum(LAST_REVIEWS?.records, 0);
      const storeSelected = !!(storeSelect && storeSelect.value);

      if (storeSelected && (weeklyCount === 0 || reviewCount === 0)) {
        const msg = "No data matched this shop. This may indicate store_id mismatch between endpoints.";
        setHTML(glanceList, `<li>${escapeHtml(msg)}</li>`);
        setText(glanceStamp, new Date().toLocaleTimeString());
        setHTML(topList, msg);
        setHTML(bottomList, msg);
        return;
      }

      if (weeklyCount < 3 || storesReporting < 3) {
        const msg = "Insufficient weekly coverage to rank shops yet. Pulling more locations will enable ranking.";
        setHTML(glanceList, `<li>${escapeHtml(msg)}</li>`);
        setText(glanceStamp, new Date().toLocaleTimeString());
        setHTML(topList, "—");
        setHTML(bottomList, "—");
        return;
      }

      const sortedByAvg = [...rows].sort((a,b) => a.avg - b.avg);
      const worst = sortedByAvg[0];
      const best = [...rows].sort((a,b) => b.avg - a.avg)[0];
      const biggestDrop = [...rows].sort((a,b) => a.dStars - b.dStars)[0];
      const biggestSpike = [...rows].sort((a,b) => b.dReviews - a.dReviews)[0];

      const alerts = [];
      if (worst && Number.isFinite(worst.avg)) {
        alerts.push({ label: `Lowest rating: ${fmt2(worst.avg)}★ → ${rowStoreText(worst.raw)}`, row: worst.raw });
      }
      if (biggestDrop && Number.isFinite(biggestDrop.dStars)) {
        alerts.push({ label: `Largest rating drop: ${fmt2(biggestDrop.dStars)}★ → ${rowStoreText(biggestDrop.raw)}`, row: biggestDrop.raw });
      }
      if (biggestSpike && Number.isFinite(biggestSpike.dReviews)) {
        alerts.push({ label: `Review spike: Δ ${fmt(biggestSpike.dReviews)} → ${rowStoreText(biggestSpike.raw)}`, row: biggestSpike.raw });
      }
      if (rated.length) {
        alerts.push({ label: `Negative feedback: ${negPct}% of rated reviews (≤2★)`, row: worst?.raw || best?.raw });
      }

      setHTML(glanceList, alerts.slice(0,5).map((a,i) => `<li class="clickable" data-alert="${i}">${escapeHtml(a.label)}</li>`).join("") || "<li>No alerts yet.</li>");
      for (const el of glanceList.querySelectorAll("[data-alert]")){
        const idx = Number(el.getAttribute("data-alert")) || 0;
        addListener(el, "click", () => selectStoreFromRow(alerts[idx]?.row || {}));
      }
      setText(glanceStamp, new Date().toLocaleTimeString());

      const sortedTop = [...rows].sort((a,b) => b.avg - a.avg).slice(0,3);
      const sortedBottom = [...rows].sort((a,b) => a.avg - b.avg).slice(0,3);

      setHTML(topList, sortedTop.map((r,i) => {
        const line = `${escapeHtml(rowStoreText(r.raw))} — ${fmt2(r.avg)}★`;
        return `<span class="mono clickable" data-top="${i}">• ${line}</span>`;
      }).join("<br>") || "—");
      setHTML(bottomList, sortedBottom.map((r,i) => {
        const line = `${escapeHtml(rowStoreText(r.raw))} — ${fmt2(r.avg)}★`;
        return `<span class="mono clickable" data-bottom="${i}">• ${line}</span>`;
      }).join("<br>") || "—");

      for (const el of topList.querySelectorAll("[data-top]")){
        const idx = Number(el.getAttribute("data-top")) || 0;
        addListener(el, "click", () => selectStoreFromRow(sortedTop[idx]?.raw || {}));
      }
      for (const el of bottomList.querySelectorAll("[data-bottom]")){
        const idx = Number(el.getAttribute("data-bottom")) || 0;
        addListener(el, "click", () => selectStoreFromRow(sortedBottom[idx]?.raw || {}));
      }
    }

    function openKpiModal(type){
      if (!kpiModal || !kpiModalBody || !kpiModalTitle) return;
      const k = LAST_EXEC?.kpis || {};
      const weekText = CURRENT_WEEK_LABEL || LAST_EXEC?.week_ending || "—";
      const total = fmt(k.total_reviews ?? 0);
      const stores = fmt(k.stores_reporting ?? 0);
      const avg = fmt2(k.avg_stars_overall ?? 0);

      const map = {
        week: { title: "Week Ending", body: `Week ending is ${weekText}.` , sort:"week"},
        stores: { title: "Shops Reporting", body: `Counted unique shop IDs in weekly rollup: ${stores}.`, sort:"store"},
        reviews: { title: "Total Reviews (Selected)", body: `Sum of total_reviews across weekly rollup rows: ${total}.`, sort:"total"},
        avg: { title: "Avg Stars (Weighted)", body: `Weighted average by total_reviews: ${avg}★.`, sort:"avg"}
      };
      const m = map[type] || map.week;
      setText(kpiModalTitle, m.title);
      const tableRows = (LAST_EXEC?.rows || []).map(normalizeRow).sort((a,b) => {
        const dir = (m.sort === "avg" || m.sort === "total") ? -1 : 1;
        return ((a[m.sort] ?? 0) - (b[m.sort] ?? 0)) * dir;
      }).slice(0,10);
      const mini = `
        <div>${escapeHtml(m.body)}</div>
        <table style="width:100%; margin-top:10px; font-size:12px; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:6px; border-bottom:1px solid var(--border);">Shop</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">Avg</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid var(--border);">Total</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows.map(r => `
              <tr>
                <td style="padding:6px; border-bottom:1px solid var(--border);">${escapeHtml(r.store || "—")}</td>
                <td style="padding:6px; text-align:right; border-bottom:1px solid var(--border);">${fmt2(r.avg)}</td>
                <td style="padding:6px; text-align:right; border-bottom:1px solid var(--border);">${fmt(r.total)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
      setHTML(kpiModalBody, mini);
      showEl(kpiModal, "flex");
      addListener(kpiModalEvidence, "click", () => {
        sortKey = m.sort;
        sortDir = (m.sort === "avg" || m.sort === "total") ? "desc" : "asc";
        setView("ops");
        renderTable(LAST_EXEC?.rows || []);
        $("weeklySection")?.scrollIntoView({ behavior: "smooth", block: "start" });
        hideEl(kpiModal);
      }, { once:true });
    }

    function latestExecRowForStore(store){
      if (!store || !LAST_EXEC?.rows) return null;
      const name = (store.name || "").toLowerCase();
      const city = (store.city || "").toLowerCase();
      const state = (store.state || "").toLowerCase();
      const rows = (LAST_EXEC.rows || []).filter(r => {
        const rn = (r.store || r.store_name || "").toLowerCase();
        const rc = (r.city || "").toLowerCase();
        const rs = (r.state || "").toLowerCase();
        return rn === name && rc === city && rs === state;
      });
      return rows.sort((a,b) => (a.week_ending > b.week_ending ? -1 : 1))[0] || null;
    }

    function reviewNegPctForStore(store){
      if (!store || !LAST_REVIEWS?.rows) return null;
      const sid = store.id || store.place_id || store.store_id || "";
      let rows = (LAST_REVIEWS.rows || []).filter(r => String(r.storeId || r.store_id || "") === String(sid));
      if (!rows.length) {
        const target = normalizeName(store.name || "");
        rows = (LAST_REVIEWS.rows || []).filter(r => normalizeName(r.storeName || r.store_name || "") === target);
      }
      const ratings = rows.map(r => safeNum(r.rating ?? r.stars, 0)).filter(x => x > 0);
      if (!ratings.length) return null;
      const neg = ratings.filter(x => x <= 2).length;
      return Math.round((neg / ratings.length) * 100);
    }

    function renderCompare(){
      if (!compareSelect || !compareCards || !compareChips) return;
      const selected = [...compareSelect.selectedOptions].map(o => o.value).filter(Boolean);
      if (selected.length > 4) {
        selected.splice(4);
        for (const opt of compareSelect.options) {
          if (selected.includes(opt.value)) opt.selected = true;
          else opt.selected = false;
        }
      }
      if (compareBtn) compareBtn.disabled = selected.length < 2;
      setHTML(compareChips, selected.map(id => {
        const s = STORES_ALL.find(x => (x.id || x.place_id || x.store_id) === id);
        return `<span class="chip">${escapeHtml(storeLabel(s || { id }))}</span>`;
      }).join("") || "—");

      const cards = selected.map(id => {
        const s = STORES_ALL.find(x => (x.id || x.place_id || x.store_id) === id);
        const execRow = latestExecRowForStore(s);
        const n = normalizeRow(execRow || {});
        const negPct = reviewNegPctForStore(s);
        return `
          <div class="card" style="min-height:auto;">
            <div class="kpi-label">${escapeHtml(storeLabel(s || { name: "Shop" }))}</div>
            <div class="kpi-sub">avg ${fmt2(n.avg)}★ • total ${fmt(n.total)}</div>
            <div class="kpi-sub">Δ stars ${fmt2(n.dStars)} • Δ reviews ${fmt(n.dReviews)}</div>
            <div class="kpi-sub">Neg% ${negPct == null ? "—" : `${negPct}%`}</div>
          </div>
        `;
      });
      setHTML(compareCards, cards.join("") || "<div class='empty'>Select 2–4 shops to compare.</div>");
    }

    function exportTableCSV(){
      const rows = (LAST_EXEC?.rows || []).map(normalizeRow);
      if (!rows.length) return;
      const header = ["week","shop","city","state","total","avg","dReviews","dStars","source"];
      const csv = [header.join(",")].concat(rows.map(r => [
        r.week, r.store, r.city, r.state, r.total, r.avg, r.dReviews, r.dStars, r.source
      ].map(v => `"${String(v ?? "").replaceAll('"','""')}"`).join(","))).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `pb1_exec_weekly_${Date.now()}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function renderTable(rows){
      if (tbody) setHTML(tbody, "");

      const week = getSelectedWeek();
      let filtered = rows.map(normalizeRow);

      if (week){
        filtered = filtered.filter(x => x.week === week);
      }

      if (TABLE_COMPARE_FILTER && TABLE_COMPARE_FILTER.length){
        const set = new Set(TABLE_COMPARE_FILTER.map(x => (x.name || "").toLowerCase() + "|" + (x.city || "").toLowerCase() + "|" + (x.state || "").toLowerCase()));
        filtered = filtered.filter(x => set.has((x.store || "").toLowerCase() + "|" + (x.city || "").toLowerCase() + "|" + (x.state || "").toLowerCase()));
      }

      // Sort
      filtered.sort((a,b) => {
        const dir = (sortDir === "asc") ? 1 : -1;
        const ak = a[sortKey], bk = b[sortKey];
        // number vs string
        if (typeof ak === "number" && typeof bk === "number") return (ak - bk) * dir;
        return String(ak ?? "").localeCompare(String(bk ?? "")) * dir;
      });

      if (!filtered.length){
        setEmptyState();
      } else {
        hideEl(emptyState);
      }

      let displayRows = filtered;
      if (filtered.length > 500) {
        displayRows = filtered.slice(0, TABLE_LIMIT);
        if (loadMoreBtn) showEl(loadMoreBtn, "inline-block");
      } else if (loadMoreBtn) {
        hideEl(loadMoreBtn);
      }

      for (const x of displayRows){
        const r = x.raw;
        const tr = document.createElement("tr");

        const cells = [
          x.week || "—",
          x.store || "—",
          x.city,
          x.state,
          { v: fmt(x.total), cls: "right mono" },
          { v: fmt2(x.avg), cls: "right mono" },
          { v: fmt(x.dReviews), cls: "right mono" },
          { v: fmt2(x.dStars), cls: "right mono" },
          x.source ? displaySourceName(x.source) : "—"
        ];

        for (const c of cells){
          const td = document.createElement("td");
          if (typeof c === "object"){
            setText(td, c.v);
            td.className = c.cls || "";
          } else {
            setText(td, c);
          }
          tr.appendChild(td);
        }

        addListener(tr, "click", () => selectStoreFromRow(r));
        if (tbody) tbody.appendChild(tr);
      }
    }

    function renderPriorityPanel(execJson){
      const rows = (execJson?.rows || []).map(normalizeRow);
      const storesReporting = safeNum(execJson?.kpis?.stores_reporting, 0);

      if (!rows.length){
        setText(priorityHintEl, "No weekly rows");
        setText(prioWorst, "—"); setText(prioWorstSub, "—");
        setText(prioDrop, "—");  setText(prioDropSub, "—");
        setText(prioSpike, "—"); setText(prioSpikeSub, "—");
        return;
      }

      if (rows.length < 3 || storesReporting < 3) {
        setText(priorityHintEl, "Insufficient weekly coverage to rank shops yet.");
        setText(prioWorst, "—"); setText(prioWorstSub, "—");
        setText(prioDrop, "—");  setText(prioDropSub, "—");
        setText(prioSpike, "—"); setText(prioSpikeSub, "—");
        if (listWorst) setHTML(listWorst, "—");
        if (listSpikes) setHTML(listSpikes, "—");
        return;
      }

      // lowest avg
      const worst = [...rows].sort((a,b) => a.avg - b.avg)[0];
      setText(prioWorst, Number.isFinite(worst.avg) ? fmt2(worst.avg) : "—");
      setText(prioWorstSub, rowStoreText(worst.raw));

      // biggest star drop (most negative)
      const drop = [...rows].sort((a,b) => a.dStars - b.dStars)[0];
      setText(prioDrop, Number.isFinite(drop.dStars) && drop.dStars !== 0 ? fmt2(drop.dStars) : "—");
      setText(prioDropSub, rowStoreText(drop.raw));

      // biggest review spike (most positive)
      const spike = [...rows].sort((a,b) => b.dReviews - a.dReviews)[0];
      setText(prioSpike, Number.isFinite(spike.dReviews) && spike.dReviews !== 0 ? fmt(spike.dReviews) : "—");
      setText(prioSpikeSub, rowStoreText(spike.raw));

      addListener($("tileWorst"), "click", () => selectStoreFromRow(worst.raw));
      addListener($("tileDrop"), "click", () => selectStoreFromRow(drop.raw));
      addListener($("tileSpike"), "click", () => selectStoreFromRow(spike.raw));

      // lists
      const worstList = [...rows].sort((a,b) => a.avg - b.avg).slice(0,10);
      const spikeList = [...rows].sort((a,b) => b.dReviews - a.dReviews).slice(0,10);

      if (listWorst) setHTML(listWorst, worstList.map((r,i) => {
        const line = `${escapeHtml(rowStoreText(r.raw))} — ${fmt2(r.avg)}★`;
        return `<span class="mono" style="cursor:pointer" data-worst="${i}">• ${line}</span>`;
      }).join("<br>") || "—");

      if (listSpikes) setHTML(listSpikes, spikeList.map((r,i) => {
        const line = `${escapeHtml(rowStoreText(r.raw))} — Δ ${fmt(r.dReviews)} reviews`;
        return `<span class="mono" style="cursor:pointer" data-spike="${i}">• ${line}</span>`;
      }).join("<br>") || "—");

      // click-to-filter from lists
      for (const el of (listWorst ? listWorst.querySelectorAll("[data-worst]") : [])){
        addListener(el, "click", (e) => {
          e.stopPropagation();
          const idx = Number(el.getAttribute("data-worst")) || 0;
          selectStoreFromRow(worstList[idx]?.raw || {});
        });
      }
      for (const el of (listSpikes ? listSpikes.querySelectorAll("[data-spike]") : [])){
        addListener(el, "click", (e) => {
          e.stopPropagation();
          const idx = Number(el.getAttribute("data-spike")) || 0;
          selectStoreFromRow(spikeList[idx]?.raw || {});
        });
      }

      setText(priorityHintEl, `Weekly rows: ${fmt(rows.length)}`);
    }

    function closeDrawer(){
      hideEl($("drawerBackdrop"));
    }

    function drawSpark(values){
      const svg = $("spark");
      setHTML(svg, "");

      if (!values.length){
        setHTML(svg, `<text x="10" y="24" fill="rgba(255,255,255,.6)" font-size="12">No data</text>`);
        return;
      }

      const w = 400, h = 160;
      const pad = 14;

      const min = Math.min(...values);
      const max = Math.max(...values);
      const span = (max - min) || 1;

      const xStep = (w - pad*2) / Math.max(values.length - 1, 1);

      const pts = values.map((v,i) => {
        const x = pad + i * xStep;
        const y = pad + (h - pad*2) * (1 - ((v - min)/span));
        return {x,y,v};
      });

      const midY = h/2;
      const grid = document.createElementNS("http://www.w3.org/2000/svg","line");
      grid.setAttribute("x1","0"); grid.setAttribute("x2", w);
      grid.setAttribute("y1", midY); grid.setAttribute("y2", midY);
      grid.setAttribute("stroke","rgba(255,255,255,.08)");
      svg.appendChild(grid);

      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      const d = pts.map((p,i) => (i===0 ? `M ${p.x} ${p.y}` : `L ${p.x} ${p.y}`)).join(" ");
      path.setAttribute("d", d);
      path.setAttribute("fill","none");
      path.setAttribute("stroke","rgba(255,255,255,.85)");
      path.setAttribute("stroke-width","2");
      svg.appendChild(path);

      for (const p of pts){
        const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
        c.setAttribute("cx", p.x);
        c.setAttribute("cy", p.y);
        c.setAttribute("r", "3.2");
        c.setAttribute("fill","rgba(255,255,255,.9)");
        svg.appendChild(c);
      }

      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x","10");
      t.setAttribute("y","20");
      t.setAttribute("fill","rgba(255,255,255,.7)");
      t.setAttribute("font-size","12");
      setText(t, `Avg Stars (min ${min.toFixed(2)} • max ${max.toFixed(2)})`);
      svg.appendChild(t);
    }

    async function openDrawer(row){
      const backdrop = $("drawerBackdrop");
      const title = $("drawerTitle");
      const subtitle = $("drawerSubtitle");
      const drawerReviews = $("drawerReviews");

      setText(title, (row.store ?? row.store_name ?? row.place_name ?? "Shop"));

      const storeId = row.store_id || null;
      const match = storeId ? STORES.find(s => (s.id || s.store_id) === storeId) : null;
      setText(subtitle, match ? storeLabel(match) : `${row.city || ""} ${row.state || ""}`.trim() || "—");

      const weekVal = row.week_ending ?? row.week ?? "—";
      setText($("dReviews"), fmt(row.total_reviews ?? 0));
      setText($("dAvg"), fmt2(row.avg_stars ?? row.avg_rating ?? 0));
      setText(drawerWeeklySource, displaySourceName(currentSource()));
      setText(drawerReviewSource, displaySourceName(currentSource()));
      if (match) renderStoreProfile(match.id || match.place_id || match.store_id || "");

      const all = (LAST_EXEC?.rows || []).filter(r => {
        if (row.store_id && r.store_id) return r.store_id === row.store_id;
        return (r.store_name === row.store_name) && (r.state === row.state);
      });

      const series = all
        .map(r => ({ w: r.week_ending ?? r.week, avg: Number(r.avg_stars ?? r.avg_rating ?? 0) || 0 }))
        .filter(x => x.w)
        .sort((a,b) => (a.w > b.w ? 1 : -1));

      const last = series.slice(-8);
      setText($("dRows"), `points=${last.length} • latest_week=${weekVal}`);

      const linksEl = $("dLinks");
      if (linksEl) setHTML(linksEl, "");
      const urls = (all.map(r => r.review_url || r.reviewUrl).filter(Boolean)).slice(0,3);
      if (urls.length){
        if (linksEl) setHTML(linksEl, urls.map(u => `<div>• <a target="_blank" rel="noreferrer noopener" href="${escapeHtml(u)}">review link</a></div>`).join(""));
      } else {
        setText(linksEl, "(no review links in weekly rollup)");
      }

      drawSpark(last.map(x => x.avg));

      // Drawer reviews (live fetch for this store, respects platform filter)
      if (drawerReviews) setHTML(drawerReviews, `<div class="empty">Loading shop reviews…</div>`);
      try{
        const source = currentSource();
        const qs = new URLSearchParams();
        qs.set("limit","8");
        if (storeId) qs.set("store_id", storeId);
        qs.set("source", "apify");

        const url = `${REVIEWS_URL}?${qs.toString()}`;
        log(`GET ${url}`);
        const json = await fetchJSON(url);

        if (!json.ok){
          if (drawerReviews) setHTML(drawerReviews, `<div class="empty">Failed to load: ${escapeHtml(json.error || "Unknown error")}</div>`);
        } else {
          let rows = (json.rows || []);
          rows = rows.filter(r => r && String(r.source || "").toLowerCase().includes("apify"));
          if (!rows.length){
            const msg = "No live reviews yet for this scope.";
            if (drawerReviews) setHTML(drawerReviews, `<div class="empty">${escapeHtml(msg)}</div>`);
          } else {
            if (drawerReviews) setHTML(drawerReviews, rows.map(r => {
              const date = r.review_date ? escapeHtml(r.review_date) : "";
              const who = r.reviewer_name ? escapeHtml(r.reviewer_name) : "Anonymous";
              const src = r.source ? escapeHtml(displaySourceName(r.source)) : "";
              const txt = r.review_text ? escapeHtml(r.review_text) : "";
              const link = r.url ? escapeHtml(r.url) : "";
              return `
                <div class="review-card">
                  <div class="review-top">
                    <div>
                      <div class="review-name">${who}</div>
                      <div class="review-meta">${date}${src ? ` • <span style="color:#8ad;">${src}</span>` : ""}</div>
                    </div>
                    <div class="review-stars">${stars(r.rating)}</div>
                  </div>
                  <div class="review-text">${txt || "<span style='color:var(--muted);'>No text</span>"}</div>
                  ${link ? `<div class="review-link"><a href="${link}" target="_blank" rel="noreferrer noopener">Open review</a></div>` : ""}
                </div>
              `;
            }).join(""));
          }
        }
      }catch(e){
        if (drawerReviews) setHTML(drawerReviews, `<div class="empty">Error: ${escapeHtml(String(e.message || e))}</div>`);
      }

      if (backdrop) {
        showEl(backdrop, "flex");
        addListener(backdrop, "click", (e) => {
          if (e.target === backdrop) closeDrawer();
        }, { once:true });
      }
    }

    function updateReviewInsights(rows, storeLabelText){
      const total = rows.length;
      const ratings = rows.map(r => Number(r.rating ?? r.stars ?? 0) || 0).filter(x => x > 0);

      const avg = ratings.length ? (ratings.reduce((a,b)=>a+b,0) / ratings.length) : 0;

      const negCount = ratings.filter(x => x <= 2).length;
      const negPct = ratings.length ? (negCount / ratings.length) * 100 : 0;

      const now = new Date();
      const cutoff = new Date(now.getTime() - 14*24*60*60*1000);
      const last14 = rows.filter(r => {
        const d = parseDateSafe(r.review_date);
        return d && d >= cutoff;
      }).length;

      setText(kpiTotalReviews, fmt(total));
      setText(kpiAvgRating, fmt2(avg));
      setText(kpiLast14, fmt(last14));
      setText(kpiNegPct, ratings.length ? `${negPct.toFixed(0)}%` : "—");

      setText(kpiTotalReviewsSub, storeLabelText);
      setText(kpiAvgRatingSub, ratings.length ? `based on ${ratings.length} rated reviews` : "no ratings found");
      setText(kpiLast14Sub, `cutoff: ${cutoff.toLocaleDateString()}`);
      setText(kpiNegPctSub, ratings.length ? `${negCount} / ${ratings.length} reviews` : "no ratings found");

      // for priority tile
      setText(prioNeg, ratings.length ? `${negPct.toFixed(0)}%` : "—");
      setText(prioNegSub, ratings.length ? `${negCount} negatives out of ${ratings.length} rated` : "no rated reviews");

      drawTrendCanvas(rows);
    }
    function normalizeReviewRow(r){
      const reviewId = r.id ?? r.review_id ?? r.uid ?? null;
      const storeId = r.store_id ?? r.shop_id ?? r.place_id ?? null;
      const storeName = r.store_name ?? r.shop_name ?? r.location_name ?? "";
      const rating = safeNum(r.rating ?? r.stars ?? r.score, 0);
      const dateRaw = r.review_date ?? r.date ?? r.publishedAt ?? r.created_at ?? r.time ?? null;
      const text = r.review_text ?? r.text ?? r.content ?? "";
      return {
        ...r,
        reviewId,
        storeId,
        storeName,
        rating,
        review_date: dateRaw,
        review_text: text,
        sourceName: displaySourceName(r.source)
      };
    }

    function drawTrendCanvas(rows){
      const c = trendCanvas;
      if (!c) return;
      const ctx = c.getContext("2d");
      if (!ctx) return;

      ctx.clearRect(0,0,c.width,c.height);

      const pts = rows
        .map(r => {
          const d = parseDateSafe(r.review_date);
          const y = Number(r.rating ?? r.stars ?? 0) || 0;
          return { d, y };
        })
        .filter(p => p.d && p.y > 0)
        .sort((a,b) => a.d - b.d);

      const capped = pts.slice(-70);

      const W = c.width, H = c.height;
      const padL = 36, padR = 14, padT = 14, padB = 28;
      const plotW = W - padL - padR;
      const plotH = H - padT - padB;

      ctx.globalAlpha = 1;
      ctx.lineWidth = 1;

      ctx.fillStyle = "rgba(255,255,255,.55)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, monospace";
      ctx.fillText("5★", 8, padT + 6);
      ctx.fillText("1★", 8, padT + plotH);

      for (let s=1; s<=5; s++){
        const y = padT + plotH * (1 - (s-1)/4);
        ctx.strokeStyle = "rgba(255,255,255,.08)";
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL + plotW, y);
        ctx.stroke();
      }

      if (!capped.length){
        ctx.fillStyle = "rgba(255,255,255,.55)";
        ctx.font = "13px ui-sans-serif, system-ui, -apple-system";
        ctx.fillText("No rated reviews to chart yet.", padL, padT + 24);
        return;
      }

      const minY = 1, maxY = 5;
      const xStep = plotW / Math.max(capped.length - 1, 1);

      const toX = (i) => padL + i * xStep;
      const toY = (val) => {
        const t = (val - minY) / (maxY - minY);
        return padT + plotH * (1 - t);
      };

      ctx.strokeStyle = "rgba(255,255,255,.85)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      capped.forEach((p,i) => {
        const x = toX(i);
        const y = toY(p.y);
        if (i === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,.90)";
      capped.forEach((p,i) => {
        const x = toX(i);
        const y = toY(p.y);
        ctx.beginPath();
        ctx.arc(x, y, 3.0, 0, Math.PI*2);
        ctx.fill();
      });

      const first = capped[0].d;
      const last  = capped[capped.length - 1].d;
      ctx.fillStyle = "rgba(255,255,255,.55)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, monospace";
      ctx.fillText(`${first.toLocaleDateString()} → ${last.toLocaleDateString()} • points=${capped.length}`, padL, H - 10);
    }

    function drawVolumeTrend(rows, canvas){
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (!ctx) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const counts = new Map();
      for (const r of rows){
        const d = parseDateSafe(r.review_date);
        if (!d) continue;
        const key = d.toISOString().slice(0,10);
        counts.set(key, (counts.get(key) || 0) + 1);
      }
      const pts = [...counts.entries()].sort((a,b) => a[0] > b[0] ? 1 : -1).slice(-20);
      if (!pts.length){
        ctx.fillStyle = "rgba(255,255,255,.6)";
        ctx.font = "13px ui-sans-serif";
        ctx.fillText("No review volume data.", 10, 20);
        return;
      }
      const values = pts.map(p => p[1]);
      const max = Math.max(...values, 1);
      const W = canvas.width, H = canvas.height;
      const pad = 18;
      const barW = (W - pad*2) / values.length;
      ctx.fillStyle = "rgba(255,255,255,.75)";
      values.forEach((v,i) => {
        const h = (H - pad*2) * (v / max);
        ctx.fillRect(pad + i * barW, H - pad - h, Math.max(barW - 4, 2), h);
      });
    }

    function drawRatingDistribution(rows, canvas){
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (!ctx) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const counts = [0,0,0,0,0];
      for (const r of rows){
        const rating = Math.round(Number(r.rating ?? r.stars ?? 0));
        if (rating >=1 && rating <=5) counts[rating-1] += 1;
      }
      const max = Math.max(...counts, 1);
      const W = canvas.width, H = canvas.height;
      const pad = 18;
      const barW = (W - pad*2) / 5;
      ctx.fillStyle = "rgba(255,255,255,.75)";
      counts.forEach((v,i) => {
        const h = (H - pad*2) * (v / max);
        ctx.fillRect(pad + i * barW, H - pad - h, Math.max(barW - 6, 4), h);
        ctx.fillStyle = "rgba(255,255,255,.65)";
        ctx.font = "12px ui-monospace";
        ctx.fillText(`${i+1}★`, pad + i * barW + 4, H - 6);
        ctx.fillStyle = "rgba(255,255,255,.75)";
      });
    }

    function updateMarketingCx(rows){
      const rated = rows.map(r => safeNum(r.rating ?? r.stars, 0)).filter(x => x > 0);
      const fiveStar = rated.filter(x => x === 5).length;
      const fivePct = rated.length ? Math.round((fiveStar / rated.length) * 100) : 0;
      if (marketingFiveStarPct) setText(marketingFiveStarPct, rated.length ? `5★ share: ${fivePct}%` : "5★ share: —");
      if (marketingHighlights) {
        const highlights = rows.filter(r => Number(r.rating ?? r.stars) === 5 && (r.review_text || "").length > 20).slice(0,5);
        setHTML(marketingHighlights, highlights.map(r => `• ${escapeHtml((r.review_text || "").slice(0,140))}`).join("<br>") || "—");
      }
      drawVolumeTrend(rows, marketingTrend);
      drawRatingDistribution(rows, cxDist);
      if (cxLowReviews) {
        const low = rows.filter(r => Number(r.rating ?? r.stars) <= 3 && (r.review_text || "")).slice(0,6);
        setHTML(cxLowReviews, low.map(r => `• ${escapeHtml((r.review_text || "").slice(0,140))}`).join("<br>") || "—");
      }
    }

    function computePlatformMix(rows){
      const counts = new Map();
      for (const r of rows || []){
        const s = (r.source || "unknown").toString().trim() || "unknown";
        counts.set(s, (counts.get(s) || 0) + 1);
      }
      const arr = Array.from(counts.entries()).map(([k,v]) => ({ k, v }))
        .sort((a,b) => b.v - a.v);
      return arr;
    }

    function renderPlatformBars(mix){
      if (platformBarsEl) setHTML(platformBarsEl, "");
      if (!mix.length){
        const reviewCount = safeNum(LAST_REVIEWS?.records, 0);
        if (platformBarsEl) {
          setHTML(
            platformBarsEl,
            reviewCount > 0
              ? `<div class="empty">Feedback sample: ${fmt(reviewCount)} reviews</div>`
              : ""
          );
        }
        return;
      }
      const total = mix.reduce((a,b)=>a+b.v,0) || 1;

      for (const m of mix.slice(0,8)){
        const pct = Math.round((m.v / total) * 100);
        const row = document.createElement("div");
        row.className = "barRow";
        setHTML(row, `
          <div class="barLbl mono">${escapeHtml(displaySourceName(m.k))}</div>
          <div class="bar"><span style="width:${pct}%"></span></div>
          <div class="barVal mono">${pct}%</div>
        `);
        if (platformBarsEl) platformBarsEl.appendChild(row);
      }
    }

    function renderExecutiveSummary(execJson, reviewsJson){
      const now = new Date();
      setText(summaryStampEl, now.toLocaleTimeString());

      const k = execJson?.kpis || {};
      const stores = safeNum(k.stores_reporting, 0);
      const total = safeNum(k.total_reviews, 0);
      const avgStars = safeNum(k.avg_stars_overall, 0);

      const reviewRows = (LAST_REVIEWS?.rows || reviewsJson?.rows || []);
      const reviewCount = safeNum(LAST_REVIEWS?.records ?? reviewsJson?.records ?? 0, 0);
      const ratings = reviewRows.map(r => safeNum(r.rating ?? r.stars, 0)).filter(x => x > 0);
      const avgReview = ratings.length ? (ratings.reduce((a,b)=>a+b,0) / ratings.length) : 0;
      const negCount = ratings.filter(x => x <= 2).length;
      const negPct = ratings.length ? (negCount / ratings.length) * 100 : 0;

      const worst = (execJson?.rows || []).map(normalizeRow).sort((a,b)=>a.avg - b.avg)[0];
      const drop = (execJson?.rows || []).map(normalizeRow).sort((a,b)=>a.dStars - b.dStars)[0];

      const weekText = CURRENT_WEEK_LABEL || "Latest (all weeks)";
      const platformText = displaySourceName(currentSource());
      const storeText = (storeSelect && storeSelect.value)
        ? (getStoreById(storeSelect.value)?.name || "selected shop")
        : "all shops";

      const status = avgStars >= 4.2 && negPct < 10 ? "Healthy" : (avgStars >= 3.8 ? "Watch" : "Critical");

      const lines = [];
      lines.push(`Status: ${status} • Week: ${weekText}`);
      lines.push(`Scope: ${storeText} • ${platformText}`);
      lines.push(`Key metrics: ${fmt(stores)} shops reporting • ${fmt(total)} reviews • avg ${fmt2(avgStars)}★`);
      if (reviewCount > 0){
        lines.push(`Feedback sample: ${fmt(reviewCount)} reviews`);
      }
      if (ratings.length){
        lines.push(`Customer signals: ${fmt(ratings.length)} rated reviews • avg ${fmt2(avgReview)}★ • negative ${negPct.toFixed(0)}% (≤2★)`);
      }
      const fallbackUsed = !!execJson?.meta?.fallbackUsed;
      const execRowCount = (execJson?.rows || []).length;
      if (fallbackUsed){
        lines.push(execRowCount ? "Data note: Derived from latest available reviews" : "No weekly rollup found for this market/week");
      }

      setText(execSummaryEl, lines.join("\n"));

      const primary = worst || drop || null;
      if (execPrimaryLabel) {
        setText(execPrimaryLabel, primary ? `Primary action: ${rowStoreText(primary.raw)}` : "Primary action: —");
      }
      if (execPrimaryBtn) {
        execPrimaryBtn.disabled = !primary;
        execPrimaryBtn.onclick = () => {
          if (primary) selectStoreFromRow(primary.raw);
        };
      }

      if (evidenceBtn) {
        evidenceBtn.disabled = false;
      }

      // badges
      if (summaryBadgesEl) setHTML(summaryBadgesEl, "");
      const badges = [
        { t: `Shops: ${fmt(stores)}` },
        { t: `Reviews: ${fmt(total)}` },
        { t: `Avg: ${fmt2(avgStars)}★` },
        ratings.length ? { t: `Neg: ${negPct.toFixed(0)}%` } : null
      ].filter(Boolean);

      for (const b of badges){
        const el = document.createElement("span");
        el.className = "badge mono";
        setText(el, b.t);
        if (summaryBadgesEl) summaryBadgesEl.appendChild(el);
      }

      // platform mix
      const mix = computePlatformMix(reviewRows);
      renderPlatformBars(mix);
    }

    function updateViewHeaders(){
  const k = LAST_EXEC?.kpis || {};
  const stores = safeNum(k.stores_reporting, 0);
  const totalReviews = safeNum(k.total_reviews, 0);
  const avgStars = safeNum(k.avg_stars_overall, 0);
  const reviewRows = LAST_REVIEWS?.rows || [];
  const rated = reviewRows.map(r => safeNum(r.rating ?? r.stars, 0)).filter(x => x > 0);
  const avgReview = rated.length ? (rated.reduce((a,b)=>a+b,0) / rated.length) : 0;
  const weekLabel = CURRENT_WEEK_LABEL || "Latest (all weeks)";
  if (viewHeaderMain) {
    const qualifiers = [];
    if (stores < 3) qualifiers.push("early sample");
    if (totalReviews < 10) qualifiers.push("limited reviews");
    const qualifierText = qualifiers.length ? ` (${qualifiers.join(", ")})` : "";
    setHTML(viewHeaderMain, `<strong>Executive Overview</strong> • ${weekLabel} • shops ${fmt(stores)} • reviews ${fmt(totalReviews)} • avg ${fmt2(avgStars)}★${qualifierText}`);
  }
  if (viewHeaderWeekly) {
    setHTML(viewHeaderWeekly, `<strong>Weekly Summary</strong> • ${weekLabel} • records ${fmt(LAST_EXEC?.records ?? 0)} • shops ${fmt(stores)} • avg ${fmt2(avgStars)}★`);
  }
  if (viewHeaderFeedback) {
    setHTML(viewHeaderFeedback, `<strong>Feedback Summary</strong> • ${weekLabel} • reviews ${fmt(LAST_REVIEWS?.records ?? 0)} • rated ${fmt(rated.length)} • avg ${fmt2(avgReview)}★`);
  }
}

async function fetchReviewsJson({ limit=50, source="apify", state="", city="", store_id="" } = {}){
  const qs = new URLSearchParams();
  qs.set("limit", String(limit));
  if (source) qs.set("source", source);
  if (state) qs.set("state", state);
  if (city) qs.set("city", city);
  if (store_id) qs.set("store_id", store_id);

  const url = `${API_BASE}/api/reviews?${qs.toString()}`;
  const headers = { "Accept": "application/json" };
  if (READ_TOKEN) headers["X-Read-Token"] = READ_TOKEN;
  const res = await fetch(url, { headers });
  if (!res.ok) throw new Error(`reviews_http_${res.status}`);
  return await res.json();
}

function normalizeStateForApi(v){
  v = String(v || "").trim();
  if (!v) return "";
  if (v.length <= 2) return v.toUpperCase(); // IL
  return v.charAt(0).toUpperCase() + v.slice(1).toLowerCase(); // Illinois
}

async function loadReviews(){
  try{
    const store_id = storeSelect ? String(storeSelect.value || "").trim() : "";
    const source = "apify";

    const stateRaw = (stateInput?.value || MARKET_FILTERS?.state || "");
    const state = normalizeStateForApi(stateRaw);
    const city  = String((cityInput?.value  || MARKET_FILTERS?.city  || "")).trim();

    const reviewsJson = await fetchReviewsJson({ limit: 60, source, state, city, store_id });
    LAST_REVIEWS = reviewsJson;
    renderReviews(reviewsJson?.rows || [], reviewsJson);
    return reviewsJson;
  } catch (e){
    console.error("loadReviews failed:", e);
    LAST_REVIEWS = { ok:false, rows:[], records:0, error:String(e?.message || e) };
    renderReviews([], LAST_REVIEWS);
    showError(`Failed to load reviews: ${e?.message || e}`);
    return null;
  }
}

    addListener(compareBtn, "click", renderCompare);
    addListener(compareSelect, "change", renderCompare);
    addListener(compareSearch, "input", debounce(applyCompareSearch, 200));
    addListener(compareEvidenceBtn, "click", () => {
      const selected = [...(compareSelect?.selectedOptions || [])].map(o => o.value).filter(Boolean);
      TABLE_COMPARE_FILTER = selected.map(id => STORES_ALL.find(s => (s.id || s.place_id || s.store_id) === id)).filter(Boolean);
      sortKey = "avg";
      sortDir = "desc";
      setView("ops");
      renderTable(LAST_EXEC?.rows || []);
      $("weeklySection")?.scrollIntoView({ behavior: "smooth", block: "start" });
    });
    addListener(compareClearBtn, "click", () => {
      TABLE_COMPARE_FILTER = null;
      if (compareSelect) {
        for (const opt of compareSelect.options) opt.selected = false;
      }
      renderCompare();
    });
    addListener(debugToggle, "click", () => {
      if (!debugDetails) return;
      debugDetails.open = !debugDetails.open;
      syncDebugToggle();
    });
    addListener(debugDetails, "toggle", syncDebugToggle);

    addListener(loadMoreBtn, "click", () => {
      TABLE_LIMIT += 200;
      renderTable(LAST_EXEC?.rows || []);
    });

    addListener($("kpiCardWeek"), "click", () => openKpiModal("week"));
    addListener($("kpiCardStores"), "click", () => openKpiModal("stores"));
    addListener($("kpiCardReviews"), "click", () => openKpiModal("reviews"));
    addListener($("kpiCardAvgStars"), "click", () => openKpiModal("avg"));

    addListener(themeSelect, "change", () => {
      const v = themeSelect?.value || "dark";
      document.body.setAttribute("data-theme", v);
      localStorage.setItem("pb1_theme", v);
    });
    addListener(exportCsvBtn, "click", () => exportTableCSV());
    addListener(openExecJsonBtn, "click", () => jsonBtn?.click());
    addListener(openReviewsJsonBtn, "click", () => {
      const pretty = JSON.stringify({ reviews: LAST_REVIEWS }, null, 2);
      const w = window.open("", "_blank", "noopener,noreferrer");
      w.document.write(`<pre style="white-space:pre-wrap;font-family:ui-monospace">${pretty.replaceAll("<","&lt;")}</pre>`);
      w.document.close();
    });
    addListener(evidenceBtn, "click", () => {
      if (!evidenceModal || !evidenceBody) return;
      const storeId = storeSelect ? storeSelect.value : "";
      const storeLabelText = storeId ? (getStoreById(storeId)?.name || "Selected shop") : "All shops";
      const weeklyUrl = LAST_URLS?.weekly || "—";
      const reviewsUrl = LAST_URLS?.reviews || "—";
      setHTML(evidenceBody, `
        <div><strong>Store</strong>: ${escapeHtml(storeLabelText)}${storeId ? ` (${escapeHtml(storeId)})` : ""}</div>
        <div><strong>exec-weekly URL</strong>: <span class="mono">${escapeHtml(weeklyUrl)}</span></div>
        <div><strong>reviews URL</strong>: <span class="mono">${escapeHtml(reviewsUrl)}</span></div>
      `);
      showEl(evidenceModal, "flex");
    });
    addListener(evidenceClose, "click", () => hideEl(evidenceModal));
    addListener(evidenceModal, "click", (e) => {
      if (e.target === evidenceModal) hideEl(evidenceModal);
    });

    // Main data loading orchestrator
    async function runApply(){
      try{
        clearError();
        setLoadingState("Loading weekly data…");
        const week = getSelectedWeek();
        const store = storeSelect ? storeSelect.value : "";
        const storeUpdate = await loadStores();
        if (storeUpdate?.aborted) return;
        if (storeUpdate?.clearedStore) {
          await loadDashboard({ store: "", week: LAST_EXEC?.week_ending || week });
        } else {
          await loadDashboard({ store, week });
        }
        await loadMetrics();
        await loadReviews();
        await loadDebug();
        renderMainDashboard(LAST_EXEC, LAST_REVIEWS);
        updateDebugPanel();
      }catch(e){
        console.error("[runApply] Error:", e);
        showError(String(e.message || e));
      }
    }
    window.runApply = runApply; // expose globally

    // Auto-apply changes
    const debouncedWeekApply = debounce(() => runApply(), 300);
    addListener(weekAllToggle, "change", () => {
      syncWeekControls();
      updateWeekNavButtons();
      updateWeekWindowLabel();
      debouncedWeekApply();
    });
    addListener(weekDateInput, "change", () => {
      if (!weekDateInput) return;
      const snapped = snapToMetaWeek(weekDateInput.value);
      if (snapped) weekDateInput.value = snapped;
      updateWeekNavButtons();
      updateWeekWindowLabel();
      debouncedWeekApply();
    });
    addListener(weekPrevBtn, "click", () => {
      if (!weekDateInput) return;
      const weeks = (META?.weeks || []).filter(Boolean).slice().sort();
      const current = getSelectedWeek();
      const idx = weeks.indexOf(current);
      if (idx > 0) {
        weekDateInput.value = weeks[idx - 1];
        updateWeekNavButtons();
        updateWeekWindowLabel();
        debouncedWeekApply();
      }
    });
    addListener(weekNextBtn, "click", () => {
      if (!weekDateInput) return;
      const weeks = (META?.weeks || []).filter(Boolean).slice().sort();
      const current = getSelectedWeek();
      const idx = weeks.indexOf(current);
      if (idx > -1 && idx < weeks.length - 1) {
        weekDateInput.value = weeks[idx + 1];
        updateWeekNavButtons();
        updateWeekWindowLabel();
        debouncedWeekApply();
      }
    });
    addListener(storeSelect, "change", async () => {
      renderStoreProfile(storeSelect ? storeSelect.value : "");
      await runApply();
    });
    addListener(sourceSelect, "change", runApply);
    addListener(presetSelect, "change", () => {
      const name = presetSelect?.value || "";
      if (!name) {
        if (presetDeleteBtn) presetDeleteBtn.disabled = true;
        return;
      }
      const preset = loadPresets().find(p => p.name === name);
      if (presetDeleteBtn) presetDeleteBtn.disabled = false;
      applyPreset(preset);
    });
    addListener(presetSaveBtn, "click", () => {
      const nameRaw = window.prompt("Preset name?");
      const name = (nameRaw || "").trim();
      if (!name) return;
      const list = loadPresets();
      const idx = list.findIndex(p => p.name === name);
      if (idx >= 0) {
        const ok = window.confirm(`Overwrite preset "${name}"?`);
        if (!ok) return;
        list.splice(idx, 1);
      }
      list.push({ name, ...getCurrentPresetState() });
      savePresets(list);
      refreshPresetUI();
      if (presetSelect) presetSelect.value = name;
      if (presetDeleteBtn) presetDeleteBtn.disabled = false;
    });
    addListener(presetDeleteBtn, "click", () => {
      const name = presetSelect?.value || "";
      if (!name) return;
      const list = loadPresets().filter(p => p.name !== name);
      savePresets(list);
      refreshPresetUI();
    });
    addListener(storeSearch, "input", debounce(applyStoreSearch, 200));
    addListener(applyBtn, "click", async () => {
      MARKET_FILTERS = getMarketFiltersFromInputs();
      persistMarketFilters(MARKET_FILTERS);
      await runApply();
    });

    // Sorting handlers
    document.querySelectorAll("thead th.sortable").forEach(th => {
      addListener(th, "click", () => {
        const key = th.getAttribute("data-sort");
        if (!key) return;
        if (sortKey === key){
          sortDir = (sortDir === "asc") ? "desc" : "asc";
        } else {
          sortKey = key;
          // default sort direction by type
          sortDir = (["store","city","state","source","week"].includes(key)) ? "asc" : "asc";
        }
        if (LAST_EXEC) renderTable(LAST_EXEC.rows || []);
      });
    });

    // Init
  (async function init(){
  try{
    const urlFilters = loadMarketFiltersFromUrl();
    const storedFilters = loadMarketFiltersFromStorage();

    MARKET_FILTERS = {
      state: urlFilters.state ?? storedFilters.state ?? null,
      city:  urlFilters.city  ?? storedFilters.city  ?? null,
    };

    setMarketFiltersInInputs(MARKET_FILTERS);
    refreshPresetUI();
    syncWeekControls();
    updateScopeMeta();
    syncDebugToggle();

    if (themeSelect) {
      const theme = localStorage.getItem("pb1_theme") || "dark";
      themeSelect.value = theme;
      document.body.setAttribute("data-theme", theme);
    }

    clearError();
    setLoadingState("Loading metadata…");
    await runApply();
  } catch(e){
    console.error("[PB1][INIT] Error:", e);
    showError(String(e.message || e));
    setSubline({
      ok: false,
      last_updated: new Date().toISOString(),
      records: LAST_EXEC?.records ?? 0,
      viewingLabel: storeSelect?.value ? "Selected shop" : "All shops"
    });
  }
})();

// Safety net: force boot on DOMContentLoaded if init IIFE didn't run
window.addEventListener("DOMContentLoaded", () => {
  try {
    console.log("[PB1][BOOT] DOMContentLoaded", document.readyState);
    if (typeof runApply === "function") {
      console.log("[PB1][BOOT] runApply available");
    } else {
      console.error("[PB1][BOOT] runApply missing");
    }
  } catch (e) {
    console.error("[PB1][BOOT] crash", e);
  }
});